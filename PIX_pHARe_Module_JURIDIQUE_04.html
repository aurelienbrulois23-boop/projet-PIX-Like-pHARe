<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIX-pHARe | Le Protocole pHARe</title>
    <style>
        :root {
            --primary: #e67e22;
            --accent: #c0392b;
            --success: #27ae60;
            --warning: #f1c40f;
            --dark: #1a1510;
            --darker: #0f0a05;
            --card: #2c2015;
            --light: #f5e6d3;
            --gold: #ffd700;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #2a1a0a 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .app-container {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(230,126,34,0.2), 0 0 0 1px rgba(230,126,34,0.1);
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        .app-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, #e67e22, #c0392b, #f1c40f);
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 {
            font-size: 2.2em;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(230,126,34,0.3);
        }
        .header .subtitle { color: var(--warning); font-size: 1.1em; }
        .header .level-badge {
            background: linear-gradient(135deg, var(--primary), #d35400);
            color: #fff;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }
        .progress-container { background: var(--darker); border-radius: 10px; padding: 15px 20px; margin-bottom: 25px; }
        .progress-bar-outer { background: rgba(255,255,255,0.1); border-radius: 10px; height: 12px; overflow: hidden; margin-top: 10px; }
        .progress-bar-inner { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 10px; transition: width 0.5s ease; }
        .progress-stats { display: flex; justify-content: space-between; font-size: 0.9em; }
        .xp-badge { background: var(--gold); color: #000; padding: 3px 12px; border-radius: 15px; font-weight: bold; }
        .btn {
            background: linear-gradient(135deg, var(--primary), #d35400);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(230,126,34,0.4); }
        .btn-secondary { background: linear-gradient(135deg, #555, #444); }
        .btn-success { background: linear-gradient(135deg, var(--success), #1e8449); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d4ac0d); color: #000; }
        .btn-block { width: 100%; justify-content: center; }
        .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .card { background: linear-gradient(145deg, #3a2a1a, #2c2015); color: var(--light); padding: 30px; border-radius: 15px; margin: 20px 0; border: 1px solid rgba(230,126,34,0.2); }
        .flashcard-container { perspective: 1000px; margin: 25px 0; }
        .flashcard {
            background: linear-gradient(145deg, #f5e6d3, #e8d5c0);
            color: var(--dark);
            padding: 40px 30px;
            border-radius: 15px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.6s, box-shadow 0.3s;
            transform-style: preserve-3d;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        .flashcard:hover { box-shadow: 0 20px 50px rgba(0,0,0,0.4); }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard .front, .flashcard .back { backface-visibility: hidden; position: absolute; width: calc(100% - 60px); }
        .flashcard .back { transform: rotateY(180deg); }
        .flashcard .question { font-size: 1.3em; font-weight: 600; line-height: 1.5; color: var(--dark); }
        .flashcard .answer { font-size: 1.1em; line-height: 1.6; color: var(--dark); }
        .flashcard .answer-label { color: var(--primary); font-weight: bold; font-size: 0.9em; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; }
        .flashcard .source { margin-top: 20px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 0.85em; color: #666; font-style: italic; }
        .flashcard .tap-hint { position: absolute; bottom: 15px; font-size: 0.8em; color: #888; }
        .card-counter { text-align: center; margin-bottom: 15px; font-size: 0.95em; opacity: 0.8; }
        .quiz-question { background: var(--darker); padding: 25px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--primary); }
        .quiz-question .label { color: var(--primary); font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .quiz-choices { display: flex; flex-direction: column; gap: 12px; }
        .quiz-choice {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            color: var(--light);
            padding: 18px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 1rem;
        }
        .quiz-choice:hover { background: rgba(230,126,34,0.15); border-color: var(--primary); transform: translateX(5px); }
        .quiz-choice.correct { background: rgba(39,174,96,0.3); border-color: var(--success); }
        .quiz-choice.incorrect { background: rgba(192,57,43,0.3); border-color: var(--accent); }
        .quiz-choice.disabled { pointer-events: none; opacity: 0.6; }
        .feedback { padding: 20px; border-radius: 12px; margin-top: 20px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .feedback.correct { background: rgba(39,174,96,0.2); border: 1px solid var(--success); }
        .feedback.incorrect { background: rgba(192,57,43,0.2); border: 1px solid var(--accent); }
        .feedback .title { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
        .feedback.correct .title { color: var(--success); }
        .feedback.incorrect .title { color: var(--accent); }
        .dojo-scenario { background: linear-gradient(135deg, var(--darker), #1a0a00); padding: 25px; border-radius: 12px; border: 1px solid rgba(230,126,34,0.3); margin-bottom: 20px; }
        .dojo-scenario .context-label { color: var(--primary); font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .dojo-scenario .context { font-size: 1.05em; line-height: 1.7; margin-bottom: 20px; }
        .dojo-scenario .question { background: rgba(241,196,15,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--warning); }
        .impact-badge { display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; margin-left: 10px; }
        .impact-positive { background: var(--success); color: #fff; }
        .impact-negative { background: var(--accent); color: #fff; }
        .impact-neutral { background: var(--warning); color: #000; }
        .save-code-section { background: var(--darker); border: 2px dashed var(--primary); border-radius: 12px; padding: 25px; margin: 25px 0; }
        .save-code-box { background: #000; color: var(--primary); font-family: 'Courier New', monospace; padding: 20px; border-radius: 8px; word-break: break-all; font-size: 0.85em; line-height: 1.5; user-select: all; margin: 15px 0; max-height: 120px; overflow-y: auto; }
        .save-instructions { background: rgba(230,126,34,0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 8px; margin-top: 20px; }
        .save-instructions h4 { color: var(--primary); margin-bottom: 10px; }
        .save-instructions ul { margin-left: 20px; line-height: 1.8; }
        .report { background: linear-gradient(145deg, #f5e6d3, #e8d5c0); color: var(--dark); border-radius: 15px; overflow: hidden; }
        .report-header { background: linear-gradient(135deg, var(--primary), #d35400); color: white; padding: 30px; text-align: center; }
        .report-header h2 { font-size: 1.8em; margin-bottom: 5px; }
        .report-body { padding: 30px; }
        .report-stat { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #ccc; }
        .report-stat:last-child { border-bottom: none; }
        .report-stat .label { color: #666; }
        .report-stat .value { font-weight: bold; color: var(--dark); }
        .mastery-badge { display: inline-block; padding: 8px 20px; border-radius: 25px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .mastery-expert { background: linear-gradient(135deg, var(--gold), #d4ac0d); color: #000; }
        .mastery-confirmed { background: linear-gradient(135deg, var(--primary), #d35400); color: #fff; }
        .mastery-learning { background: linear-gradient(135deg, #3498db, #2980b9); color: #fff; }
        .unlock-section { background: linear-gradient(135deg, #2a1a0a, var(--darker)); border: 2px solid var(--warning); border-radius: 15px; padding: 30px; text-align: center; margin: 20px 0; }
        .unlock-section h3 { color: var(--warning); margin-bottom: 15px; }
        .unlock-section input { width: 100%; padding: 15px; border: 2px solid #444; border-radius: 8px; background: var(--darker); color: var(--primary); font-family: 'Courier New', monospace; font-size: 0.9em; margin: 15px 0; }
        .unlock-section input:focus { outline: none; border-color: var(--primary); }
        .error-msg { color: var(--accent); font-weight: bold; margin-top: 10px; }
        .level-indicator { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
        .level-dot { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; background: var(--darker); border: 3px solid #444; transition: all 0.3s; }
        .level-dot.active { border-color: var(--primary); box-shadow: 0 0 20px rgba(230,126,34,0.5); }
        .level-dot.completed { background: var(--success); border-color: var(--success); }
        @media (max-width: 600px) { body { padding: 10px; } .app-container { padding: 20px; } .header h1 { font-size: 1.6em; } .flashcard { padding: 25px 20px; min-height: 250px; } .btn { padding: 12px 20px; font-size: 0.9rem; } }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script>
        const MODULE_DATA = {
            id: "JURIDIQUE_04",
            version: "1.0.0",
            titre: "LE PROTOCOLE pHARe",
            sous_titre: "Pilier 4 : ProcÃ©dures Institutionnelles",
            description: "MaÃ®triser les protocoles officiels : signalement Article 40, programme pHARe, mÃ©thode de la prÃ©occupation partagÃ©e (MPP).",
            auteur: "Programme pHARe",
            prerequis: "JURIDIQUE_03",
            niveau_difficulte: 4,
            
            niveau1: {
                titre: "L'Architecture Institutionnelle",
                type: "flashcards",
                xp_reward: 125,
                cartes: [
                    {
                        recto: "Qu'est-ce que l'ARTICLE 40 du Code de ProcÃ©dure PÃ©nale ?",
                        verso: "Obligation pour tout fonctionnaire ayant connaissance d'un CRIME ou DÃ‰LIT d'en informer le Procureur de la RÃ©publique SANS DÃ‰LAI.\n\nLe signalement doit contenir :\nâ€¢ IdentitÃ© des auteurs prÃ©sumÃ©s\nâ€¢ IdentitÃ© des tÃ©moins\nâ€¢ RÃ©cit dÃ©taillÃ© des faits",
                        source: "Code de ProcÃ©dure PÃ©nale - Art. 40"
                    },
                    {
                        recto: "Que risque un agent qui NE signale PAS un dÃ©lit dont il a connaissance ?",
                        verso: "â€¢ Sanctions DISCIPLINAIRES (blÃ¢me, suspension...)\nâ€¢ Engagement de sa responsabilitÃ© personnelle\n\nLe dÃ©faut de signalement est une FAUTE PROFESSIONNELLE caractÃ©risÃ©e.\n\nL'agent ne peut pas \"protÃ©ger\" l'Ã©lÃ¨ve en ne signalant pas.",
                        source: "Article 40 CPP & Statut Fonction Publique"
                    },
                    {
                        recto: "Quels sont les 5 PILIERS du programme pHARe ?",
                        verso: "1. Ã‰DUQUER : Former les Ã©lÃ¨ves Ã  la prÃ©vention\n\n2. FORMER : Qualifier les adultes rÃ©fÃ©rents\n\n3. INTERVENIR : Protocoles de prise en charge\n\n4. ASSOCIER : Impliquer les parents\n\n5. MOBILISER : RÃ´le des Ã©lÃ¨ves ambassadeurs",
                        source: "Programme pHARe - MinistÃ¨re EN"
                    },
                    {
                        recto: "Qu'est-ce que la MÃ‰THODE DE LA PRÃ‰OCCUPATION PARTAGÃ‰E (MPP) ?",
                        verso: "MÃ©thode d'intervention NON-BLÃ‚MANTE oÃ¹ l'adulte exprime sa prÃ©occupation pour la victime aux auteurs, SANS les accuser directement.\n\nObjectif : Responsabiliser l'auteur en le rendant acteur de la solution, pas objet de la sanction.\n\nPAS adaptÃ© aux cas graves â†’ procÃ©dure disciplinaire directe.",
                        source: "MÃ©thode Pikas - pHARe"
                    },
                    {
                        recto: "Ã€ quel moment de l'annÃ©e doit Ãªtre rÃ©alisÃ©e la DÃ‰TECTION systÃ©matique selon pHARe ?",
                        verso: "Questionnaires d'auto-Ã©valuation ANONYMES dÃ¨s le mois de NOVEMBRE.\n\nObjectif : RepÃ©rer les situations invisibles avant qu'elles ne dÃ©gÃ©nÃ¨rent.\n\nRappel : Les victimes parlent rarement spontanÃ©ment (honte, peur des reprÃ©sailles).",
                        source: "Calendrier pHARe"
                    },
                    {
                        recto: "Quelles SANCTIONS DISCIPLINAIRES peuvent Ãªtre prononcÃ©es pour harcÃ¨lement dans le second degrÃ© ?",
                        verso: "Ã‰chelle progressive :\nâ€¢ Avertissement\nâ€¢ BlÃ¢me\nâ€¢ Mesure de responsabilisation\nâ€¢ Exclusion temporaire (max 8 jours)\nâ€¢ Exclusion dÃ©finitive (conseil de discipline)\n\nDepuis 2022 : Engagement OBLIGATOIRE de procÃ©dures disciplinaires.",
                        source: "Circulaire pHARe 2023"
                    }
                ]
            },
            
            niveau2: {
                titre: "Protocole en Action",
                type: "quiz",
                xp_reward: 175,
                questions: [
                    {
                        texte: "Un Ã©lÃ¨ve te confie Ãªtre harcelÃ© depuis 2 mois. Il te demande de ne rien dire aux adultes car il a peur que \"Ã§a empire\".",
                        question: "Quelle est ta position en tant qu'ambassadeur pHARe ?",
                        choix: [
                            { txt: "Je respecte sa demande de confidentialitÃ© pour ne pas le trahir", correct: false, feedback: "ERREUR ! Le silence = complicitÃ© passive + mise en danger. Ta loyautÃ© envers lui passe par la PROTECTION, pas par le silence. Les adultes sont formÃ©s pour agir discrÃ¨tement." },
                            { txt: "Je l'accompagne pour signaler, en lui expliquant que c'est pour sa protection", correct: true, feedback: "PARFAIT ! Tu ne le \"trahis\" pas, tu le PROTÃˆGES. Explique-lui que les adultes rÃ©fÃ©rents sont formÃ©s, que l'anonymat sera prÃ©servÃ© au maximum, et que NE RIEN FAIRE = laisser la situation empirer." },
                            { txt: "J'attends de voir si Ã§a s'aggrave avant d'agir", correct: false, feedback: "DANGEREUX ! 2 mois de harcÃ¨lement = situation dÃ©jÃ  grave. Attendre = accumuler les dÃ©gÃ¢ts psychologiques. Le temps joue CONTRE la victime." }
                        ]
                    },
                    {
                        texte: "Un professeur te dit qu'il a vu des insultes sur le casier d'un Ã©lÃ¨ve mais qu'il \"ne veut pas se mÃªler de Ã§a\" car \"Ã§a va se calmer tout seul\".",
                        question: "Que lui rappelles-tu poliment ?",
                        choix: [
                            { txt: "Qu'il a raison, les adultes ne doivent pas trop intervenir entre Ã©lÃ¨ves", correct: false, feedback: "FAUX ! Les adultes ont une OBLIGATION de vigilance et de signalement. L'article 40 CPP impose de signaler tout dÃ©lit constatÃ©." },
                            { txt: "Qu'en tant que fonctionnaire, il a une obligation lÃ©gale de signalement (Art. 40)", correct: true, feedback: "EXACT ! Article 40 CPP : tout fonctionnaire DOIT signaler. Le dÃ©faut de signalement engage sa responsabilitÃ© disciplinaire. \"Ne pas se mÃªler\" n'est pas une option lÃ©gale." },
                            { txt: "Que c'est le rÃ´le du CPE, pas le sien", correct: false, feedback: "FAUX ! TOUS les personnels sont concernÃ©s par l'obligation de signalement. Le CPE coordonne, mais chacun a son rÃ´le. TÃ©moin = responsable de signaler." }
                        ]
                    },
                    {
                        texte: "Tu constates qu'un groupe de 3 Ã©lÃ¨ves isole systÃ©matiquement un camarade depuis 1 semaine. Aucune violence physique, juste de l'exclusion.",
                        question: "Selon le protocole pHARe, quelle mÃ©thode d'intervention est la plus adaptÃ©e en PREMIÃˆRE intention ?",
                        choix: [
                            { txt: "Conseil de discipline immÃ©diat pour les 3 auteurs", correct: false, feedback: "DISPROPORTIONNÃ‰ en premiÃ¨re intention. Le conseil de discipline est rÃ©servÃ© aux cas graves ou aux rÃ©cidives. Ici, la MPP peut suffire Ã  rÃ©gler la situation." },
                            { txt: "MÃ©thode de la PrÃ©occupation PartagÃ©e (MPP)", correct: true, feedback: "ADAPTÃ‰ ! Pas de violence physique, situation rÃ©cente : la MPP permet de responsabiliser les auteurs en les rendant acteurs de la solution. Si Ã©chec â†’ escalade vers le disciplinaire." },
                            { txt: "Ne rien faire car il n'y a pas de violence physique", correct: false, feedback: "GRAVE ERREUR ! L'exclusion sociale EST du harcÃ¨lement psychologique. La loi ne distingue pas physique/psychologique. L'impact sur la victime peut Ãªtre tout aussi destructeur." }
                        ]
                    },
                    {
                        texte: "Lors d'un entretien MPP avec un auteur prÃ©sumÃ©, celui-ci nie en bloc : \"C'est pas moi, j'ai rien fait.\"",
                        question: "Quelle est la bonne posture selon la mÃ©thode ?",
                        choix: [
                            { txt: "Insister avec des preuves jusqu'Ã  ce qu'il avoue", correct: false, feedback: "Ce n'est PAS l'approche MPP. La mÃ©thode Ã©vite la confrontation accusatoire. Insister sur les preuves = transformer l'entretien en interrogatoire, ce qui ferme le dialogue." },
                            { txt: "Recentrer sur la prÃ©occupation : \"Untel ne va pas bien. Que pourrais-tu faire pour amÃ©liorer les choses ?\"", correct: true, feedback: "EXACTEMENT ! La MPP ne cherche pas l'aveu mais l'engagement. \"Je suis prÃ©occupÃ© pour X. Toi qui le connais, que proposes-tu ?\" L'auteur devient acteur de la solution, pas accusÃ©." },
                            { txt: "Abandonner la MPP et passer directement Ã  la sanction", correct: false, feedback: "PrÃ©maturÃ© ! Le dÃ©ni initial est frÃ©quent. La force de la MPP est de contourner les dÃ©fenses. Si aprÃ¨s plusieurs entretiens le dÃ©ni persiste â†’ on escalade." }
                        ]
                    }
                ]
            },
            
            niveau3: {
                titre: "Cellule de Crise",
                type: "dojo",
                xp_reward: 225,
                scenarios: [
                    {
                        contexte: "Situation grave : une vidÃ©o humiliante d'un Ã©lÃ¨ve circule massivement sur les rÃ©seaux. L'Ã©lÃ¨ve est effondrÃ©, les parents appellent la direction, la presse locale a Ã©tÃ© alertÃ©e.",
                        question: "En tant que membre de l'Ã©quipe pHARe, quelle est la PRIORITÃ‰ ABSOLUE ?",
                        choix: [
                            { txt: "Identifier et sanctionner les auteurs immÃ©diatement", correct: false, feedback: "Important mais PAS prioritaire. L'urgence n'est pas la sanction. L'urgence est la PROTECTION DE LA VICTIME. La sanction viendra, mais elle peut attendre quelques heures." },
                            { txt: "Contacter la presse pour limiter la couverture mÃ©diatique", correct: false, feedback: "Mauvaise prioritÃ©. La communication est secondaire. Le focus doit Ãªtre sur la victime et sa famille, pas sur l'image de l'Ã©tablissement." },
                            { txt: "SÃ©curiser la victime : extraction de classe, soutien psychologique, contact famille", correct: true, feedback: "EXACT ! PRIORITÃ‰ 1 = Victime. Extraction du lieu de souffrance, Ã©coute, prÃ©sence adulte, contact parents. Tout le reste (enquÃªte, sanction, communication) vient APRÃˆS." }
                        ]
                    },
                    {
                        contexte: "Un parent vient te voir furieux. Son fils a Ã©tÃ© identifiÃ© comme harceleur. Il menace de porter plainte contre l'Ã©tablissement pour \"diffamation\" et \"acharnement\".",
                        question: "Comment gÃ¨res-tu cette situation ?",
                        choix: [
                            { txt: "Reculer sur les mesures prises pour calmer le parent", correct: false, feedback: "CATASTROPHIQUE ! Reculer sous la pression = abandonner la victime + message d'impunitÃ© aux auteurs. Les protocoles doivent Ãªtre appliquÃ©s Ã©quitablement." },
                            { txt: "Rester factuel, rappeler le cadre lÃ©gal et proposer un rendez-vous formel", correct: true, feedback: "PARFAIT ! 1) Accueillir la colÃ¨re sans l'alimenter 2) Rappeler les faits objectivement 3) Expliquer le cadre lÃ©gal (obligation de l'Ã©cole) 4) Proposer un RDV avec le chef d'Ã©tablissement pour dialogue constructif." },
                            { txt: "Renvoyer vers le chef d'Ã©tablissement sans rien dire", correct: false, feedback: "Ã‰vitement ! Tu peux amorcer le dialogue avec calme et factualitÃ©. Botter en touche sans rien dire peut aggraver la frustration du parent." }
                        ]
                    },
                    {
                        contexte: "Suite Ã  un signalement, tu apprends que l'auteur principal est lui-mÃªme victime de violences familiales. La situation est complexe.",
                        question: "Comment cette information impacte-t-elle le traitement du cas ?",
                        choix: [
                            { txt: "Ã‡a excuse son comportement, on annule les sanctions", correct: false, feedback: "NON ! Comprendre n'est pas excuser. La victime de l'Ã©lÃ¨ve mÃ©rite protection QUOI QU'IL ARRIVE. Mais cette info oriente l'ACCOMPAGNEMENT de l'auteur." },
                            { txt: "On maintient la protection de la victime ET on signale la situation familiale", correct: true, feedback: "EXACT ! Double signalement : 1) Protection de la victime de harcÃ¨lement maintenue 2) Information prÃ©occupante pour l'auteur (cellule de recueil). Un enfant maltraitÃ© qui reproduit la violence a besoin d'AIDE, pas juste de sanction." },
                            { txt: "C'est le travail des services sociaux, pas de l'Ã©cole", correct: false, feedback: "ERREUR ! L'Ã©cole est partie prenante de la protection de l'enfance. Le signalement d'information prÃ©occupante EST une obligation scolaire. On ne compartimente pas." }
                        ]
                    }
                ]
            }
        };

        const generateSaveCode = (progress) => {
            const payload = { v: 1, d: new Date().toISOString(), m: MODULE_DATA.id, mv: MODULE_DATA.version, n: progress.nom || "Anonyme", c: progress.classe || "", l: progress.currentLevel, s: progress.score, x: progress.xp, q: progress.quizScore, dj: progress.dojoScore, f: progress.finished };
            return btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        };

        const decodeSaveCode = (code) => { try { return { valid: true, data: JSON.parse(decodeURIComponent(escape(atob(code.trim())))) }; } catch (e) { return { valid: false, error: "Code invalide." }; } };

        const verifyPrerequisite = (code) => {
            const result = decodeSaveCode(code);
            if (!result.valid) return { valid: false, error: "Code invalide." };
            if (result.data.m !== MODULE_DATA.prerequis) return { valid: false, error: `Ce code provient du module ${result.data.m}, pas du module ${MODULE_DATA.prerequis}.` };
            if (!result.data.f) return { valid: false, error: "Ce module n'a pas Ã©tÃ© terminÃ©." };
            return { valid: true, data: result.data };
        };

        const e = React.createElement;
        const { useState } = React;

        function Header({ showProgress, xp }) {
            return e('div', { className: 'header' },
                e('div', { className: 'level-badge' }, `NIVEAU ${MODULE_DATA.niveau_difficulte}`),
                e('h1', null, MODULE_DATA.titre),
                e('div', { className: 'subtitle' }, MODULE_DATA.sous_titre),
                showProgress && e('div', { style: { marginTop: '10px' } }, e('span', { className: 'xp-badge' }, `âš¡ ${xp} XP`))
            );
        }

        function ProgressBar({ currentLevel, xp }) {
            const percent = Math.min(100, (currentLevel / 3) * 100);
            return e('div', { className: 'progress-container' }, e('div', { className: 'progress-stats' }, e('span', null, `Niveau ${currentLevel}/3`), e('span', { className: 'xp-badge' }, `${xp} XP`)), e('div', { className: 'progress-bar-outer' }, e('div', { className: 'progress-bar-inner', style: { width: `${percent}%` } })));
        }

        function LevelIndicator({ current }) {
            const levels = ['ðŸ“‹', 'âš™ï¸', 'ðŸš¨'];
            return e('div', { className: 'level-indicator' }, levels.map((emoji, i) => e('div', { key: i, className: `level-dot ${i + 1 === current ? 'active' : ''} ${i + 1 < current ? 'completed' : ''}` }, i + 1 < current ? 'âœ“' : emoji)));
        }

        function Flashcard({ card, onNext, isLast, onComplete }) {
            const [flipped, setFlipped] = useState(false);
            return e('div', { className: 'flashcard-container' },
                e('div', { className: `flashcard ${flipped ? 'flipped' : ''}`, onClick: () => setFlipped(!flipped) },
                    e('div', { className: 'front' }, e('div', { className: 'question', style: { whiteSpace: 'pre-line' } }, card.recto), e('div', { className: 'tap-hint' }, 'ðŸ‘† Clique pour retourner')),
                    e('div', { className: 'back' }, e('div', { className: 'answer-label' }, 'âœ“ RÃ©ponse'), e('div', { className: 'answer', style: { whiteSpace: 'pre-line' } }, card.verso), e('div', { className: 'source' }, `ðŸ“– ${card.source}`))
                ),
                e('div', { className: 'text-center', style: { marginTop: '20px' } }, flipped && (isLast ? e('button', { className: 'btn btn-success', onClick: onComplete }, 'âœ“ VALIDER') : e('button', { className: 'btn', onClick: () => { onNext(); setFlipped(false); } }, 'SUIVANT â†’')))
            );
        }

        function QuizQuestion({ question, onAnswer }) {
            const [answered, setAnswered] = useState(false);
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const handleChoice = (choice, idx) => { if (answered) return; setAnswered(true); setSelectedIdx(idx); setFeedback({ correct: choice.correct, text: choice.feedback }); };
            return e('div', null,
                e('div', { className: 'quiz-question' }, e('div', { className: 'label' }, 'ðŸ“‹ CAS PRATIQUE'), e('p', { style: { marginBottom: '15px', lineHeight: '1.6' } }, question.texte), question.question && e('p', { style: { fontWeight: 'bold', color: '#e67e22' } }, `â“ ${question.question}`)),
                e('div', { className: 'quiz-choices' }, question.choix.map((choice, idx) => e('button', { key: idx, className: `quiz-choice ${answered ? (idx === selectedIdx ? (choice.correct ? 'correct' : 'incorrect') : 'disabled') : ''}`, onClick: () => handleChoice(choice, idx), disabled: answered }, choice.txt))),
                feedback && e('div', { className: `feedback ${feedback.correct ? 'correct' : 'incorrect'}` }, e('div', { className: 'title' }, feedback.correct ? 'âœ“ PROTOCOLE RESPECTÃ‰ !' : 'âœ— ERREUR DE PROTOCOLE'), e('p', null, feedback.text), e('button', { className: 'btn', style: { marginTop: '20px' }, onClick: () => onAnswer(feedback.correct) }, 'CONTINUER â†’'))
            );
        }

        function DojoScenario({ scenario, onAnswer }) {
            const [answered, setAnswered] = useState(false);
            const [selectedChoice, setSelectedChoice] = useState(null);
            const handleChoice = (choice) => { if (answered) return; setAnswered(true); setSelectedChoice(choice); };
            const getImpactClass = (impact) => impact >= 80 ? 'impact-positive' : impact > 0 ? 'impact-neutral' : 'impact-negative';
            const getImpactLabel = (impact) => impact >= 0 ? `+${impact}` : `${impact}`;
            return e('div', null,
                e('div', { className: 'dojo-scenario' }, e('div', { className: 'context-label' }, 'ðŸš¨ CELLULE DE CRISE'), e('p', { className: 'context' }, scenario.contexte), e('div', { className: 'question' }, e('strong', null, 'â“ ', scenario.question))),
                e('div', { className: 'quiz-choices' }, scenario.choix.map((choice, idx) => e('button', { key: idx, className: `quiz-choice ${answered ? (choice === selectedChoice ? (choice.correct ? 'correct' : 'incorrect') : 'disabled') : ''}`, onClick: () => handleChoice(choice), disabled: answered }, choice.txt, answered && e('span', { className: `impact-badge ${getImpactClass(choice.impact || (choice.correct ? 100 : -20))}` }, getImpactLabel(choice.impact || (choice.correct ? 100 : -20)))))),
                selectedChoice && e('div', { className: `feedback ${selectedChoice.correct ? 'correct' : 'incorrect'}` }, e('div', { className: 'title' }, selectedChoice.correct ? 'ðŸ† GESTION DE CRISE RÃ‰USSIE !' : 'âš ï¸ FAILLE DANS LE PROTOCOLE'), e('p', null, selectedChoice.feedback), e('button', { className: 'btn', style: { marginTop: '20px' }, onClick: () => onAnswer(selectedChoice.correct ? 100 : Math.max(0, selectedChoice.impact || 0)) }, 'CONTINUER â†’'))
            );
        }

        function Report({ progress, onRestart, onMenu }) {
            const saveCode = generateSaveCode(progress);
            const [copied, setCopied] = useState(false);
            const copyToClipboard = () => { navigator.clipboard.writeText(saveCode).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }); };
            const getMasteryLevel = () => { const total = progress.quizScore + progress.dojoScore; if (total >= 500) return { label: 'EXPERT', class: 'mastery-expert' }; if (total >= 300) return { label: 'CONFIRMÃ‰', class: 'mastery-confirmed' }; return { label: 'EN FORMATION', class: 'mastery-learning' }; };
            const mastery = getMasteryLevel();
            return e('div', null,
                e('div', { className: 'report' },
                    e('div', { className: 'report-header' }, e('span', { style: { fontSize: '3em', display: 'block', marginBottom: '15px' } }, 'ðŸ“‹'), e('h2', null, 'MODULE 4 COMPLÃ‰TÃ‰'), e('p', null, MODULE_DATA.titre)),
                    e('div', { className: 'report-body' },
                        e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'Agent'), e('span', { className: 'value' }, progress.nom || 'Anonyme')),
                        progress.classe && e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'Classe'), e('span', { className: 'value' }, progress.classe)),
                        e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'XP Total'), e('span', { className: 'value' }, `${progress.xp} XP`)),
                        e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'Score Protocoles'), e('span', { className: 'value' }, `${progress.quizScore} pts`)),
                        e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'Score Crises'), e('span', { className: 'value' }, `${progress.dojoScore} pts`)),
                        e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'MaÃ®trise'), e('span', { className: `mastery-badge ${mastery.class}` }, mastery.label))
                    )
                ),
                e('div', { className: 'save-code-section' },
                    e('h3', { style: { color: '#e67e22', marginBottom: '15px' } }, 'ðŸ’¾ CODE DE SAUVEGARDE'),
                    e('p', { style: { opacity: 0.8 } }, 'Ce code dÃ©bloque le MODULE FINAL !'),
                    e('div', { className: 'save-code-box' }, saveCode),
                    e('button', { className: `btn ${copied ? 'btn-success' : ''}`, onClick: copyToClipboard }, copied ? 'âœ“ COPIÃ‰ !' : 'ðŸ“‹ COPIER'),
                    e('div', { className: 'save-instructions' }, e('h4', null, 'ðŸ”“ DerniÃ¨re Ã©tape'), e('ul', null, e('li', null, 'Ce code dÃ©bloque le Module 5 : "MaÃ®tre de l\'Harmonie"'), e('li', null, 'Le module final pour devenir Expert pHARe !')))
                ),
                e('div', { className: 'btn-group' }, e('button', { className: 'btn btn-secondary', onClick: onMenu }, 'ðŸ  MENU'), e('button', { className: 'btn btn-warning', onClick: onRestart }, 'ðŸ”„ RECOMMENCER'))
            );
        }

        function App() {
            const [mode, setMode] = useState('menu');
            const [unlocked, setUnlocked] = useState(false);
            const [currentLevel, setCurrentLevel] = useState(1);
            const [cardIdx, setCardIdx] = useState(0);
            const [questionIdx, setQuestionIdx] = useState(0);
            const [scenarioIdx, setScenarioIdx] = useState(0);
            const [xp, setXp] = useState(0);
            const [quizScore, setQuizScore] = useState(0);
            const [dojoScore, setDojoScore] = useState(0);
            const [nom, setNom] = useState('');
            const [classe, setClasse] = useState('');
            const [unlockCode, setUnlockCode] = useState('');
            const [unlockError, setUnlockError] = useState('');

            const resetProgress = () => { setCurrentLevel(1); setCardIdx(0); setQuestionIdx(0); setScenarioIdx(0); setXp(0); setQuizScore(0); setDojoScore(0); };
            const progress = { nom, classe, currentLevel, xp, quizScore, dojoScore, score: quizScore + dojoScore, finished: mode === 'report' };

            const handleUnlock = () => { const result = verifyPrerequisite(unlockCode); if (result.valid) { setNom(result.data.n || ''); setClasse(result.data.c || ''); setUnlocked(true); setUnlockError(''); } else { setUnlockError(result.error); } };

            if (mode === 'menu') {
                return e('div', { className: 'app-container' },
                    e(Header, { showProgress: false }),
                    e('div', { className: 'card' }, e('strong', null, 'ðŸŽ¯ MISSION : '), MODULE_DATA.description),
                    !unlocked ? e('div', { className: 'unlock-section' },
                        e('h3', null, 'ðŸ” MODULE VERROUILLÃ‰'),
                        e('p', null, `PrÃ©requis : ComplÃ©ter "${MODULE_DATA.prerequis}"`),
                        e('input', { type: 'text', placeholder: 'Code du Module 3...', value: unlockCode, onChange: (ev) => { setUnlockCode(ev.target.value); setUnlockError(''); } }),
                        unlockError && e('div', { className: 'error-msg' }, `âš ï¸ ${unlockError}`),
                        e('button', { className: 'btn', onClick: handleUnlock }, 'ðŸ”“ DÃ‰BLOQUER')
                    ) : e('div', { className: 'btn-group' },
                        e('div', { style: { textAlign: 'center', color: '#27ae60', marginBottom: '10px' } }, `âœ“ Bienvenue ${nom} !`),
                        e('button', { className: 'btn btn-block', onClick: () => setMode('game') }, 'â–¶ï¸ COMMENCER')
                    ),
                    e('div', { style: { marginTop: '30px', textAlign: 'center', opacity: 0.5, fontSize: '0.85em' } }, `Module ${MODULE_DATA.id} v${MODULE_DATA.version}`)
                );
            }

            if (mode === 'game') {
                if (currentLevel === 1) {
                    const cards = MODULE_DATA.niveau1.cartes;
                    return e('div', { className: 'app-container' }, e(Header, { showProgress: true, xp }), e(ProgressBar, { currentLevel, xp }), e(LevelIndicator, { current: currentLevel }), e('h2', { style: { textAlign: 'center' } }, 'ðŸ“‹ NIVEAU 1 : RÃ‰GLEMENTATION'), e('div', { className: 'card-counter' }, `Carte ${cardIdx + 1} / ${cards.length}`), e(Flashcard, { card: cards[cardIdx], isLast: cardIdx === cards.length - 1, onNext: () => setCardIdx(cardIdx + 1), onComplete: () => { setXp(xp + MODULE_DATA.niveau1.xp_reward); setCurrentLevel(2); setCardIdx(0); } }));
                }
                if (currentLevel === 2) {
                    const questions = MODULE_DATA.niveau2.questions;
                    const handleQuizAnswer = (correct) => { if (correct) setQuizScore(quizScore + 40); if (questionIdx < questions.length - 1) setQuestionIdx(questionIdx + 1); else { setXp(xp + MODULE_DATA.niveau2.xp_reward); setCurrentLevel(3); setQuestionIdx(0); } };
                    return e('div', { className: 'app-container' }, e(Header, { showProgress: true, xp }), e(ProgressBar, { currentLevel, xp }), e(LevelIndicator, { current: currentLevel }), e('h2', { style: { textAlign: 'center' } }, 'âš™ï¸ NIVEAU 2 : APPLICATION'), e('div', { className: 'card-counter' }, `Cas ${questionIdx + 1} / ${questions.length}`), e(QuizQuestion, { key: questionIdx, question: questions[questionIdx], onAnswer: handleQuizAnswer }));
                }
                if (currentLevel === 3) {
                    const scenarios = MODULE_DATA.niveau3.scenarios;
                    const handleDojoAnswer = (impact) => { setDojoScore(dojoScore + impact); if (scenarioIdx < scenarios.length - 1) setScenarioIdx(scenarioIdx + 1); else { setXp(xp + MODULE_DATA.niveau3.xp_reward); setMode('report'); } };
                    return e('div', { className: 'app-container' }, e(Header, { showProgress: true, xp }), e(ProgressBar, { currentLevel, xp }), e(LevelIndicator, { current: currentLevel }), e('h2', { style: { textAlign: 'center' } }, 'ðŸš¨ NIVEAU 3 : GESTION DE CRISE'), e('div', { className: 'card-counter' }, `Crise ${scenarioIdx + 1} / ${scenarios.length}`), e(DojoScenario, { key: scenarioIdx, scenario: scenarios[scenarioIdx], onAnswer: handleDojoAnswer }));
                }
            }

            if (mode === 'report') {
                return e('div', { className: 'app-container' }, e(Report, { progress: { ...progress, xp: xp + (currentLevel > 3 ? 0 : MODULE_DATA.niveau3.xp_reward) }, onRestart: () => { resetProgress(); setMode('game'); }, onMenu: () => { resetProgress(); setUnlocked(false); setUnlockCode(''); setMode('menu'); } }));
            }
            return e('div', { className: 'app-container' }, 'Chargement...');
        }

        ReactDOM.createRoot(document.getElementById('root')).render(e(App));
    </script>
</body>
</html>
