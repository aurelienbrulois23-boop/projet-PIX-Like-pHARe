<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIX-pHARe | AVANT LE MOT</title>
    <style>
        :root {
            --primary: #FFC400;   /* Ambre */
            --accent: #9C7C38;    /* S√©pia n√©on */
            --success: #B08D57;   /* Bronze */
            --warning: #FAF3E3;   /* Vieux Papier lumineux */
            --dark: #2C2210;      /* S√©pia fonc√© */
            --darker: #B08D57;
            --card: #F2E3C6;      /* Papier jauni */
            --light: #FAF3E3;
            --gold: #FFC400;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--light) 0%, var(--warning) 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .app-container {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(176, 141, 87, 0.20), 0 0 0 1px rgba(255,196,0,0.1);
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        .app-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--success), var(--accent));
        }
        /* HEADER */
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 {
            font-size: 2.2em;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(255, 196, 0, 0.3);
        }
        .header .subtitle {
            color: var(--accent);
            font-size: 1.1em;
            opacity: 0.9;
        }
        .header .badge {
            display: inline-block;
            background: var(--darker);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
            border: 1px solid var(--primary);
        }
        /* PROGRESS BAR */
        .progress-container {
            background: var(--darker);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 25px;
        }
        .progress-bar-outer {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }
        .xp-badge {
            background: var(--gold);
            color: #000;
            padding: 3px 12px;
            border-radius: 15px;
            font-weight: bold;
        }
        /* BUTTONS */
        .btn {
            background: linear-gradient(135deg, var(--primary), #b8903b);
            color: var(--dark);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 196, 0, 0.18);
        }
        .btn:active { transform: translateY(0); }
        .btn-secondary {
            background: linear-gradient(135deg, #E1C699, #9C7C38);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success), #a1793b);
        }
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #e7c072);
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--accent), #6f5622);
        }
        .btn-block { width: 100%; justify-content: center; }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        /* CARDS */
        .card {
            background: linear-gradient(145deg, #fffbe7, #faecd1);
            color: var(--dark);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(176,141,87,0.10);
        }
        .card-dark {
            background: var(--darker);
            color: var(--light);
        }
        /* FLASHCARD */
        .flashcard-container {
            perspective: 1000px;
            margin: 25px 0;
        }
        .flashcard {
            background: linear-gradient(145deg, #fffbe7, #faecd1);
            color: var(--dark);
            padding: 40px 30px;
            border-radius: 15px;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.6s, box-shadow 0.3s;
            transform-style: preserve-3d;
            box-shadow: 0 15px 40px rgba(176,141,87,0.14);
            position: relative;
        }
        .flashcard:hover {
            box-shadow: 0 20px 50px rgba(176,141,87,0.19);
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .flashcard .front, .flashcard .back {
            backface-visibility: hidden;
            position: absolute;
            width: calc(100% - 60px);
        }
        .flashcard .back {
            transform: rotateY(180deg);
        }
        .flashcard .question {
            font-size: 1.3em;
            font-weight: 600;
            line-height: 1.5;
        }
        .flashcard .answer {
            font-size: 1.1em;
            line-height: 1.6;
        }
        .flashcard .answer-label {
            color: var(--success);
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .flashcard .source {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e7c072;
            font-size: 0.85em;
            color: #9C7C38;
            font-style: italic;
        }
        .flashcard .tap-hint {
            position: absolute;
            bottom: 15px;
            font-size: 0.8em;
            color: #b08d57;
        }
        .card-counter {
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.95em;
            color: var(--accent);
            opacity: 0.8;
        }
        /* QUIZ */
        .quiz-question {
            background: var(--darker);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid var(--warning);
        }
        .quiz-question .label {
            color: var(--warning);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .quiz-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .quiz-choice {
            background: rgba(255,255,255,0.12);
            border: 2px solid rgba(255,255,255,0.13);
            color: var(--dark);
            padding: 18px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 1rem;
        }
        .quiz-choice:hover {
            background: rgba(255, 196, 0, 0.14);
            border-color: var(--primary);
            transform: translateX(5px);
        }
        .quiz-choice.correct {
            background: rgba(176, 141, 87, 0.13);
            border-color: var(--success);
        }
        .quiz-choice.incorrect {
            background: rgba(156, 124, 56, 0.11);
            border-color: var(--accent);
        }
        .quiz-choice.disabled {
            pointer-events: none;
            opacity: 0.6;
        }
        /* FEEDBACK */
        .feedback {
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .feedback.correct {
            background: rgba(176, 141, 87, 0.13);
            border: 1px solid var(--success);
        }
        .feedback.incorrect {
            background: rgba(156, 124, 56, 0.11);
            border: 1px solid var(--accent);
        }
        .feedback .title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .feedback.correct .title { color: var(--success); }
        .feedback.incorrect .title { color: var(--accent); }
        /* DOJO */
        .dojo-scenario {
            background: linear-gradient(135deg, var(--darker), #e2cda1);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(176,141,87,0.13);
            margin-bottom: 20px;
        }
        .dojo-scenario .context-label {
            color: var(--accent);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .dojo-scenario .context {
            font-size: 1.05em;
            line-height: 1.7;
            margin-bottom: 20px;
        }
        .dojo-scenario .question {
            background: rgba(250, 243, 227, 0.24);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--warning);
        }
        .impact-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        .impact-positive { background: var(--success); color: #fff; }
        .impact-negative { background: var(--accent); color: #fff; }
        .impact-neutral { background: var(--warning); color: #000; }
        /* Responsive */
        @media (max-width: 700px) {
            .app-container { padding: 4vw 0.5vw; }
            .flashcard { padding: 6vw 3vw; }
        }
    </style>
    <!-- React 18 CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script>
        // ==== DATA MODULE HISTOIRE_01 ====
        const MODULE_DATA = {
            id: "HISTOIRE_01",
            version: "1.0.0",
            titre: "AVANT LE MOT",
            sous_titre: "Pilier Historique & Soci√©tal",
            description: "Comprendre comment les violences entre √©l√®ves ont longtemps exist√© sans √™tre reconnues, nomm√©es ou prises en charge.",
            auteur: "Programme pHARe",
            niveau1: {
                titre: "Quand la violence ne se voyait pas",
                type: "flashcards",
                xp_reward: 50,
                cartes: [
                    {
                        recto: "Les violences entre √©l√®ves ont-elles toujours exist√© ?",
                        verso: "Oui. Les violences entre √©l√®ves existent depuis que l'√©cole existe.\n\nLa diff√©rence majeure, ce n'est pas leur apparition r√©cente, mais leur reconnaissance tardive.",
                        source: "Histoire de l'institution scolaire"
                    },
                    {
                        recto: "Pourquoi ces violences √©taient-elles longtemps invisibles ?",
                        verso: "Parce qu'elles √©taient consid√©r√©es comme normales, formatrices ou in√©vitables.\n\nSans mot pour les nommer, elles restaient hors du champ du probl√®me public.",
                        source: "Approche sociologique"
                    },
                    {
                        recto: "Que signifiait l'expression ¬´ √ßa forge le caract√®re ¬ª ?",
                        verso: "Elle justifiait la souffrance comme une √©preuve √©ducative.\n\nLa violence √©tait vue comme un passage oblig√© vers la maturit√©.",
                        source: "Discours √©ducatifs traditionnels"
                    },
                    {
                        recto: "Quel r√¥le jouait l'autorit√© scolaire autrefois ?",
                        verso: "L'√©cole reposait sur une autorit√© verticale forte, parfois violente.\n\nCela rendait les violences entre √©l√®ves secondaires ou tol√©r√©es.",
                        source: "Histoire de l'√©ducation"
                    },
                    {
                        recto: "Que se passe-t-il quand un ph√©nom√®ne n'est pas reconnu ?",
                        verso: "Il ne peut √™tre ni prot√©g√©, ni pr√©venu, ni sanctionn√©.\n\nLa souffrance devient alors un probl√®me individuel, pas collectif.",
                        source: "Analyse institutionnelle"
                    }
                ]
            },
            niveau2: {
                titre: "Voir ou ne pas voir",
                type: "quiz",
                xp_reward: 100,
                questions: [
                    {
                        texte: "Dans une √©cole des ann√©es 1950, un √©l√®ve est r√©guli√®rement moqu√© et isol√© par ses camarades.",
                        question: "Comment cette situation est-elle le plus souvent interpr√©t√©e √† l'√©poque ?",
                        choix: [
                            {
                                txt: "Comme une situation grave n√©cessitant une intervention imm√©diate.",
                                correct: false,
                                feedback: "Non. √Ä cette √©poque, ces situations sont rarement per√ßues comme un probl√®me institutionnel."
                            },
                            {
                                txt: "Comme une difficult√© personnelle de l'√©l√®ve concern√©.",
                                correct: true,
                                feedback: "Exact. La responsabilit√© est souvent attribu√©e √† l'√©l√®ve lui-m√™me, pas au groupe ni √† l'institution."
                            }
                        ]
                    },
                    {
                        texte: "Un √©l√®ve se plaint d'√™tre maltrait√© par d'autres √©l√®ves.",
                        question: "Pourquoi les adultes interviennent-ils rarement dans le pass√© ?",
                        choix: [
                            {
                                txt: "Parce qu'ils ne voient pas ces violences.",
                                correct: false,
                                feedback: "Pas exactement. Ils les voient parfois, mais ne les consid√®rent pas comme un probl√®me sp√©cifique."
                            },
                            {
                                txt: "Parce que ces violences sont per√ßues comme normales ou √©ducatives.",
                                correct: true,
                                feedback: "Correct. Elles sont int√©gr√©es √† une vision √©ducative du durcissement et de la s√©lection."
                            }
                        ]
                    },
                    {
                        texte: "Deux √©l√®ves se battent r√©guli√®rement.",
                        question: "Pourquoi cette situation n'est-elle pas qualifi√©e de harc√®lement √† l'√©poque ?",
                        choix: [
                            {
                                txt: "Parce que le concept de harc√®lement scolaire n'existe pas encore.",
                                correct: true,
                                feedback: "Exact. Sans concept, il n'y a pas de qualification sp√©cifique ni de r√©ponse adapt√©e."
                            },
                            {
                                txt: "Parce que les violences ne sont pas r√©p√©t√©es.",
                                correct: false,
                                feedback: "Non. M√™me r√©p√©t√©es, elles ne sont pas encore conceptualis√©es comme harc√®lement."
                            }
                        ]
                    }
                ]
            },
            niveau3: {
                titre: "Regard historique",
                type: "dojo",
                xp_reward: 150,
                scenarios: [
                    {
                        contexte: "Tu es √©l√®ve dans une √©cole des ann√©es 1960. Un camarade est r√©guli√®rement humili√© par un groupe.",
                        question: "Quelle est la r√©action la plus probable de l'institution ?",
                        choix: [
                            {
                                txt: "Consid√©rer que c'est une difficult√© personnelle de l'√©l√®ve.",
                                impact: 100,
                                level: "optimal",
                                feedback: "Exact. La responsabilit√© est individualis√©e, le groupe n'est pas interrog√©."
                            },
                            {
                                txt: "Mettre en place un dispositif de pr√©vention.",
                                impact: -20,
                                level: "error",
                                feedback: "Non. Ces dispositifs n'existent pas encore √† cette √©poque."
                            },
                            {
                                txt: "Reconna√Ætre officiellement une situation de harc√®lement.",
                                impact: -30,
                                level: "error",
                                feedback: "Erreur. Le concept n'est pas encore formul√©."
                            }
                        ]
                    },
                    {
                        contexte: "Un enseignant observe des moqueries r√©p√©t√©es.",
                        question: "Quelle est sa marge d'action √† cette √©poque ?",
                        choix: [
                            {
                                txt: "Intervenir ponctuellement sans cadre sp√©cifique.",
                                impact: 80,
                                level: "good",
                                feedback: "Oui. Les interventions sont individuelles, sans politique globale."
                            },
                            {
                                txt: "Activer un protocole institutionnel.",
                                impact: -20,
                                level: "error",
                                feedback: "Non. Ces protocoles n'existent pas encore."
                            },
                            {
                                txt: "Saisir la justice.",
                                impact: -30,
                                level: "error",
                                feedback: "Tr√®s improbable √† cette √©poque pour ce type de situation."
                            }
                        ]
                    }
                ]
            }
        };
         // ============================================================
        // UTILITAIRES DE SAUVEGARDE
        // ============================================================
        const generateSaveCode = (progress) => {
            const payload = {
                v: 1, // version du format
                d: new Date().toISOString(),
                m: MODULE_DATA.id,
                mv: MODULE_DATA.version,
                n: progress.nom || "Anonyme",
                c: progress.classe || "",
                l: progress.currentLevel,
                s: progress.score,
                x: progress.xp,
                q: progress.quizScore,
                dj: progress.dojoScore,
                f: progress.finished
            };
            return btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        };

        const decodeSaveCode = (code) => {
            try {
                const data = JSON.parse(decodeURIComponent(escape(atob(code.trim()))));
                if (data.m !== MODULE_DATA.id) return { valid: false, error: "Ce code est pour un autre module." };
                return { valid: true, data };
            } catch (e) {
                return { valid: false, error: "Code invalide ou corrompu." };
            }
        };

        const formatDate = (isoString) => {
            return new Date(isoString).toLocaleDateString('fr-FR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        };

        // ============================================================
        // COMPOSANTS REACT (sans JSX - compatible navigateur)
        // ============================================================
        const e = React.createElement;
        const { useState, useEffect } = React;

        // --- Header Component ---
        function Header({ showProgress, xp, currentLevel }) {
            return e('div', { className: 'header' },
                e('h1', null, MODULE_DATA.titre),
                e('div', { className: 'subtitle' }, MODULE_DATA.sous_titre),
                showProgress && e('div', { className: 'badge' }, `‚ö° ${xp} XP`)
            );
        }

        // --- Progress Bar Component ---
        function ProgressBar({ currentLevel, xp }) {
            const totalLevels = 3;
            const percent = Math.min(100, (currentLevel / totalLevels) * 100);
            
            return e('div', { className: 'progress-container' },
                e('div', { className: 'progress-stats' },
                    e('span', null, `Niveau ${currentLevel}/3`),
                    e('span', { className: 'xp-badge' }, `${xp} XP`)
                ),
                e('div', { className: 'progress-bar-outer' },
                    e('div', { className: 'progress-bar-inner', style: { width: `${percent}%` } })
                )
            );
        }

        // --- Level Indicator Component ---
        function LevelIndicator({ current }) {
            const levels = ['üìö', 'üîç', '‚öîÔ∏è'];
            return e('div', { className: 'level-indicator' },
                levels.map((emoji, i) => 
                    e('div', { 
                        key: i,
                        className: `level-dot ${i + 1 === current ? 'active' : ''} ${i + 1 < current ? 'completed' : ''}`
                    }, i + 1 < current ? '‚úì' : emoji)
                )
            );
        }

        // --- Flashcard Component ---
        function Flashcard({ card, onNext, isLast, onComplete }) {
            const [flipped, setFlipped] = useState(false);
            
            return e('div', { className: 'flashcard-container' },
                e('div', { 
                    className: `flashcard ${flipped ? 'flipped' : ''}`,
                    onClick: () => setFlipped(!flipped)
                },
                    e('div', { className: 'front' },
                        e('div', { className: 'question' }, card.recto),
                        e('div', { className: 'tap-hint' }, 'üëÜ Clique pour retourner')
                    ),
                    e('div', { className: 'back' },
                        e('div', { className: 'answer-label' }, '‚úì R√©ponse'),
                        e('div', { className: 'answer', style: { whiteSpace: 'pre-line' } }, card.verso),
                        e('div', { className: 'source' }, `üìñ ${card.source}`)
                    )
                ),
                e('div', { className: 'text-center mt-20' },
                    flipped && (
                        isLast 
                            ? e('button', { className: 'btn btn-success', onClick: onComplete }, '‚úì VALIDER LE NIVEAU 1')
                            : e('button', { className: 'btn', onClick: () => { onNext(); setFlipped(false); } }, 'CARTE SUIVANTE ‚Üí')
                    )
                )
            );
        }

        // --- Quiz Component ---
        function QuizQuestion({ question, onAnswer }) {
            const [answered, setAnswered] = useState(false);
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [feedback, setFeedback] = useState(null);

            const handleChoice = (choice, idx) => {
                if (answered) return;
                setAnswered(true);
                setSelectedIdx(idx);
                setFeedback({ correct: choice.correct, text: choice.feedback });
            };

            const handleNext = () => {
                onAnswer(feedback.correct);
            };

            return e('div', null,
                e('div', { className: 'quiz-question' },
                    e('div', { className: 'label' }, 'üìã SITUATION'),
                    e('p', { style: { marginBottom: '15px', lineHeight: '1.6' } }, question.texte),
                    question.question && e('p', { style: { fontWeight: 'bold', color: '#f39c12' } }, `‚ùì ${question.question}`)
                ),
                e('div', { className: 'quiz-choices' },
                    question.choix.map((choice, idx) => 
                        e('button', {
                            key: idx,
                            className: `quiz-choice ${answered ? (idx === selectedIdx ? (choice.correct ? 'correct' : 'incorrect') : 'disabled') : ''}`,
                            onClick: () => handleChoice(choice, idx),
                            disabled: answered
                        }, choice.txt)
                    )
                ),
                feedback && e('div', { className: `feedback ${feedback.correct ? 'correct' : 'incorrect'}` },
                    e('div', { className: 'title' }, feedback.correct ? '‚úì CORRECT !' : '‚úó ERREUR D\'ANALYSE'),
                    e('p', null, feedback.text),
                    e('button', { className: 'btn mt-20', onClick: handleNext }, 'CONTINUER ‚Üí')
                )
            );
        }

        // --- Dojo Component ---
        function DojoScenario({ scenario, onAnswer }) {
            const [answered, setAnswered] = useState(false);
            const [selectedChoice, setSelectedChoice] = useState(null);

            const handleChoice = (choice) => {
                if (answered) return;
                setAnswered(true);
                setSelectedChoice(choice);
            };

            const getImpactClass = (impact) => {
                if (impact >= 80) return 'impact-positive';
                if (impact > 0) return 'impact-neutral';
                return 'impact-negative';
            };

            const getImpactLabel = (impact) => {
                if (impact >= 80) return `+${impact} pts`;
                if (impact > 0) return `+${impact} pts`;
                return `${impact} pts`;
            };

            return e('div', null,
                e('div', { className: 'dojo-scenario' },
                    e('div', { className: 'context-label' }, 'üé¨ SC√âNARIO'),
                    e('p', { className: 'context' }, scenario.contexte),
                    e('div', { className: 'question' },
                        e('strong', null, '‚ùì ', scenario.question)
                    )
                ),
                e('div', { className: 'quiz-choices' },
                    scenario.choix.map((choice, idx) => 
                        e('button', {
                            key: idx,
                            className: `quiz-choice ${answered ? (choice === selectedChoice ? (choice.level === 'optimal' ? 'correct' : choice.level === 'error' ? 'incorrect' : '') : 'disabled') : ''}`,
                            onClick: () => handleChoice(choice),
                            disabled: answered
                        }, 
                            choice.txt,
                            answered && e('span', { className: `impact-badge ${getImpactClass(choice.impact)}` }, getImpactLabel(choice.impact))
                        )
                    )
                ),
                selectedChoice && e('div', { className: `feedback ${selectedChoice.level === 'optimal' ? 'correct' : selectedChoice.level === 'error' ? 'incorrect' : 'correct'}` },
                    e('div', { className: 'title' }, 
                        selectedChoice.level === 'optimal' ? 'üèÜ D√âCISION OPTIMALE !' : 
                        selectedChoice.level === 'error' ? '‚ö†Ô∏è D√âCISION RISQU√âE' : 'üëç BONNE PISTE'
                    ),
                    e('p', null, selectedChoice.feedback),
                    e('button', { className: 'btn mt-20', onClick: () => onAnswer(selectedChoice.impact) }, 'CONTINUER ‚Üí')
                )
            );
        }

        // --- Report Component ---
        function Report({ progress, onRestart, onMenu }) {
            const saveCode = generateSaveCode(progress);
            const [copied, setCopied] = useState(false);

            const copyToClipboard = () => {
                navigator.clipboard.writeText(saveCode).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                });
            };

            const getMasteryLevel = () => {
                const total = progress.quizScore + progress.dojoScore;
                if (total >= 500) return { label: 'EXPERT', class: 'mastery-expert' };
                if (total >= 300) return { label: 'CONFIRM√â', class: 'mastery-confirmed' };
                return { label: 'EN FORMATION', class: 'mastery-learning' };
            };

            const mastery = getMasteryLevel();

            return e('div', null,
                e('div', { className: 'report' },
                    e('div', { className: 'report-header' },
                        e('span', { className: 'emoji-big' }, 'üèÖ'),
                        e('h2', null, 'MISSION ACCOMPLIE'),
                        e('p', null, MODULE_DATA.titre)
                    ),
                    e('div', { className: 'report-body' },
                        e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'Agent'),
                            e('span', { className: 'value' }, progress.nom || 'Anonyme')
                        ),
                        progress.classe && e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'Classe'),
                            e('span', { className: 'value' }, progress.classe)
                        ),
                        e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'XP Total'),
                            e('span', { className: 'value' }, `${progress.xp} XP`)
                        ),
                        e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'Score Quiz'),
                            e('span', { className: 'value' }, `${progress.quizScore} pts`)
                        ),
                        e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'Score Dojo'),
                            e('span', { className: 'value' }, `${progress.dojoScore} pts`)
                        ),
                        e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'Niveau de Ma√Ætrise'),
                            e('span', { className: `mastery-badge ${mastery.class}` }, mastery.label)
                        )
                    )
                ),
                e('div', { className: 'save-code-section' },
                    e('h3', { style: { color: '#0f0', marginBottom: '15px' } }, 'üíæ CODE DE SAUVEGARDE'),
                    e('p', { style: { opacity: 0.8, marginBottom: '10px' } }, 
                        'Ce code contient ta progression. Conserve-le pr√©cieusement !'
                    ),
                    e('div', { className: 'save-code-box' }, saveCode),
                    e('button', { 
                        className: `btn ${copied ? 'btn-success' : ''}`,
                        onClick: copyToClipboard 
                    }, copied ? '‚úì COPI√â !' : 'üìã COPIER LE CODE'),
                    e('div', { className: 'save-instructions' },
                        e('h4', null, 'üìå Que faire avec ce code ?'),
                        e('ul', null,
                            e('li', null, '1. GARDE-LE pour reprendre plus tard au m√™me niveau'),
                            e('li', null, '2. ENVOIE-LE AU CPE pour valider ton badge pHARe'),
                            e('li', null, '3. Tu peux le coller dans un mail ou un message')
                        )
                    )
                ),
                e('div', { className: 'btn-group' },
                    e('button', { className: 'btn btn-secondary', onClick: onMenu }, 'üè† RETOUR AU MENU'),
                    e('button', { className: 'btn btn-warning', onClick: onRestart }, 'üîÑ RECOMMENCER LE MODULE')
                )
            );
        }

        // --- Main App Component ---
        function App() {
            const [mode, setMode] = useState('menu'); // menu, register, game, report, load
            const [currentLevel, setCurrentLevel] = useState(1);
            const [cardIdx, setCardIdx] = useState(0);
            const [questionIdx, setQuestionIdx] = useState(0);
            const [scenarioIdx, setScenarioIdx] = useState(0);
            const [xp, setXp] = useState(0);
            const [quizScore, setQuizScore] = useState(0);
            const [dojoScore, setDojoScore] = useState(0);
            const [nom, setNom] = useState('');
            const [classe, setClasse] = useState('');
            const [inputCode, setInputCode] = useState('');
            const [loadError, setLoadError] = useState('');

            const resetProgress = () => {
                setCurrentLevel(1);
                setCardIdx(0);
                setQuestionIdx(0);
                setScenarioIdx(0);
                setXp(0);
                setQuizScore(0);
                setDojoScore(0);
            };

            const progress = {
                nom, classe, currentLevel, xp, quizScore, dojoScore,
                score: quizScore + dojoScore,
                finished: mode === 'report'
            };

            // --- MENU ---
            if (mode === 'menu') {
                return e('div', { className: 'app-container' },
                    e(Header, { showProgress: false }),
                    e('div', { className: 'card', style: { marginTop: '20px' } },
                        e('strong', null, 'üéØ MISSION : '),
                        MODULE_DATA.description
                    ),
                    e('div', { className: 'btn-group' },
                        e('button', { className: 'btn btn-block', onClick: () => setMode('register') }, 
                            '‚ñ∂Ô∏è COMMENCER LA MISSION'
                        ),
                        e('button', { className: 'btn btn-secondary btn-block', onClick: () => setMode('load') }, 
                            'üìÇ CHARGER UNE SAUVEGARDE'
                        )
                    ),
                    e('div', { style: { marginTop: '30px', textAlign: 'center', opacity: 0.6, fontSize: '0.85em' } },
                        `Module ${MODULE_DATA.id} v${MODULE_DATA.version} ‚Äî ${MODULE_DATA.auteur}`
                    )
                );
            }

            // --- REGISTER ---
            if (mode === 'register') {
                const startGame = () => {
                    if (!nom.trim()) {
                        alert('Merci d\'entrer ton pr√©nom ou pseudo !');
                        return;
                    }
                    setMode('game');
                };

                return e('div', { className: 'app-container' },
                    e(Header, { showProgress: false }),
                    e('div', { className: 'card' },
                        e('h3', { style: { marginBottom: '20px' } }, 'üë§ Identification de l\'Agent'),
                        e('div', { style: { marginBottom: '15px' } },
                            e('label', { style: { display: 'block', marginBottom: '5px', fontWeight: 'bold' } }, 'Pr√©nom ou Pseudo *'),
                            e('input', {
                                type: 'text',
                                value: nom,
                                onChange: (ev) => setNom(ev.target.value),
                                placeholder: 'Ex: Alex',
                                style: { width: '100%', padding: '12px', borderRadius: '8px', border: '2px solid #ddd', fontSize: '1rem' }
                            })
                        ),
                        e('div', { style: { marginBottom: '15px' } },
                            e('label', { style: { display: 'block', marginBottom: '5px', fontWeight: 'bold' } }, 'Classe (optionnel)'),
                            e('input', {
                                type: 'text',
                                value: classe,
                                onChange: (ev) => setClasse(ev.target.value),
                                placeholder: 'Ex: 4√®me B',
                                style: { width: '100%', padding: '12px', borderRadius: '8px', border: '2px solid #ddd', fontSize: '1rem' }
                            })
                        )
                    ),
                    e('div', { className: 'btn-group' },
                        e('button', { className: 'btn btn-success btn-block', onClick: startGame }, 'üöÄ D√âMARRER'),
                        e('button', { className: 'btn btn-secondary btn-block', onClick: () => setMode('menu') }, '‚Üê RETOUR')
                    )
                );
            }

            // --- LOAD ---
            if (mode === 'load') {
                const handleLoad = () => {
                    const result = decodeSaveCode(inputCode);
                    if (!result.valid) {
                        setLoadError(result.error);
                        return;
                    }
                    const d = result.data;
                    setNom(d.n || 'Anonyme');
                    setClasse(d.c || '');
                    setCurrentLevel(d.l || 1);
                    setXp(d.x || 0);
                    setQuizScore(d.q || 0);
                    setDojoScore(d.dj || 0);
                    setCardIdx(0);
                    setQuestionIdx(0);
                    setScenarioIdx(0);
                    
                    if (d.f) {
                        setMode('report');
                    } else {
                        setMode('game');
                    }
                    setLoadError('');
                };

                return e('div', { className: 'app-container' },
                    e(Header, { showProgress: false }),
                    e('div', { className: 'card load-section' },
                        e('h3', { style: { marginBottom: '20px' } }, 'üìÇ Charger une Progression'),
                        e('p', { style: { marginBottom: '15px', opacity: 0.8 } }, 
                            'Colle ici le code de sauvegarde que tu as gard√© :'
                        ),
                        e('textarea', {
                            value: inputCode,
                            onChange: (ev) => { setInputCode(ev.target.value); setLoadError(''); },
                            placeholder: 'Colle ton code ici...'
                        }),
                        loadError && e('div', { style: { color: '#e74c3c', marginTop: '10px', fontWeight: 'bold' } }, 
                            `‚ö†Ô∏è ${loadError}`
                        )
                    ),
                    e('div', { className: 'btn-group' },
                        e('button', { className: 'btn btn-success btn-block', onClick: handleLoad }, '‚úì CHARGER'),
                        e('button', { className: 'btn btn-secondary btn-block', onClick: () => setMode('menu') }, '‚Üê RETOUR')
                    )
                );
            }

            // --- GAME ---
            if (mode === 'game') {
                // NIVEAU 1 : FLASHCARDS
                if (currentLevel === 1) {
                    const cards = MODULE_DATA.niveau1.cartes;
                    
                    return e('div', { className: 'app-container' },
                        e(Header, { showProgress: true, xp }),
                        e(ProgressBar, { currentLevel, xp }),
                        e(LevelIndicator, { current: currentLevel }),
                        e('h2', { style: { textAlign: 'center' } }, 'üìö NIVEAU 1 : TH√âORIE'),
                        e('div', { className: 'card-counter' }, `Carte ${cardIdx + 1} / ${cards.length}`),
                        e(Flashcard, {
                            card: cards[cardIdx],
                            isLast: cardIdx === cards.length - 1,
                            onNext: () => setCardIdx(cardIdx + 1),
                            onComplete: () => {
                                setXp(xp + MODULE_DATA.niveau1.xp_reward);
                                setCurrentLevel(2);
                                setCardIdx(0);
                            }
                        })
                    );
                }

                // NIVEAU 2 : QUIZ
                if (currentLevel === 2) {
                    const questions = MODULE_DATA.niveau2.questions;
                    
                    const handleQuizAnswer = (correct) => {
                        if (correct) setQuizScore(quizScore + 25);
                        
                        if (questionIdx < questions.length - 1) {
                            setQuestionIdx(questionIdx + 1);
                        } else {
                            setXp(xp + MODULE_DATA.niveau2.xp_reward);
                            setCurrentLevel(3);
                            setQuestionIdx(0);
                        }
                    };

                    return e('div', { className: 'app-container' },
                        e(Header, { showProgress: true, xp }),
                        e(ProgressBar, { currentLevel, xp }),
                        e(LevelIndicator, { current: currentLevel }),
                        e('h2', { style: { textAlign: 'center' } }, 'üîç NIVEAU 2 : ANALYSE'),
                        e('div', { className: 'card-counter' }, `Question ${questionIdx + 1} / ${questions.length}`),
                        e(QuizQuestion, {
                            key: questionIdx, // Force re-render on new question
                            question: questions[questionIdx],
                            onAnswer: handleQuizAnswer
                        })
                    );
                }

                // NIVEAU 3 : DOJO
                if (currentLevel === 3) {
                    const scenarios = MODULE_DATA.niveau3.scenarios;
                    
                    const handleDojoAnswer = (impact) => {
                        setDojoScore(dojoScore + Math.max(0, impact));
                        
                        if (scenarioIdx < scenarios.length - 1) {
                            setScenarioIdx(scenarioIdx + 1);
                        } else {
                            setXp(xp + MODULE_DATA.niveau3.xp_reward);
                            setMode('report');
                        }
                    };

                    return e('div', { className: 'app-container' },
                        e(Header, { showProgress: true, xp }),
                        e(ProgressBar, { currentLevel, xp }),
                        e(LevelIndicator, { current: currentLevel }),
                        e('h2', { style: { textAlign: 'center' } }, '‚öîÔ∏è NIVEAU 3 : DOJO'),
                        e('div', { className: 'card-counter' }, `Sc√©nario ${scenarioIdx + 1} / ${scenarios.length}`),
                        e(DojoScenario, {
                            key: scenarioIdx,
                            scenario: scenarios[scenarioIdx],
                            onAnswer: handleDojoAnswer
                        })
                    );
                }
            }

            // --- REPORT ---
            if (mode === 'report') {
                return e('div', { className: 'app-container' },
                    e(Report, {
                        progress: { ...progress, xp: xp + (currentLevel > 3 ? 0 : MODULE_DATA.niveau3.xp_reward) },
                        onRestart: () => { resetProgress(); setMode('register'); },
                        onMenu: () => { resetProgress(); setMode('menu'); }
                    })
                );
            }

            return e('div', { className: 'app-container' }, 'Chargement...');
        }

        // --- RENDER ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>

</body>
</html>
