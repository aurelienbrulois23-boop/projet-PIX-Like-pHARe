<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIX-pHARe | Le Spectre Num√©rique</title>
    <style>
        :root {
            --primary: #00d4ff;
            --accent: #ff006e;
            --success: #00ff88;
            --warning: #ffbe0b;
            --dark: #0a0a1a;
            --darker: #050510;
            --card: #12122a;
            --light: #e8e8e8;
            --gold: #ffd700;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #1a0a2e 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .app-container {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,212,255,0.2), 0 0 0 1px rgba(0,212,255,0.1);
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        .app-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, #00d4ff, #ff006e, #00ff88);
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 {
            font-size: 2.2em;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 5px;
            text-shadow: 0 0 20px rgba(0,212,255,0.5);
        }
        .header .subtitle { color: var(--accent); font-size: 1.1em; }
        .header .level-badge {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }
        .progress-container { background: var(--darker); border-radius: 10px; padding: 15px 20px; margin-bottom: 25px; }
        .progress-bar-outer { background: rgba(255,255,255,0.1); border-radius: 10px; height: 12px; overflow: hidden; margin-top: 10px; }
        .progress-bar-inner { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 10px; transition: width 0.5s ease; }
        .progress-stats { display: flex; justify-content: space-between; font-size: 0.9em; }
        .xp-badge { background: var(--gold); color: #000; padding: 3px 12px; border-radius: 15px; font-weight: bold; }
        .btn {
            background: linear-gradient(135deg, var(--primary), #0099cc);
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,212,255,0.4); }
        .btn-secondary { background: linear-gradient(135deg, #444, #333); color: #fff; }
        .btn-success { background: linear-gradient(135deg, var(--success), #00cc6a); color: #000; }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #cc9900); color: #000; }
        .btn-danger { background: linear-gradient(135deg, var(--accent), #cc0055); color: #fff; }
        .btn-block { width: 100%; justify-content: center; }
        .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .card { background: linear-gradient(145deg, #1a1a3a, #12122a); color: var(--light); padding: 30px; border-radius: 15px; margin: 20px 0; border: 1px solid rgba(0,212,255,0.2); }
        .flashcard-container { perspective: 1000px; margin: 25px 0; }
        .flashcard {
            background: linear-gradient(145deg, #1a1a3a, #0a0a1a);
            color: var(--light);
            padding: 40px 30px;
            border-radius: 15px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.6s, box-shadow 0.3s;
            transform-style: preserve-3d;
            box-shadow: 0 15px 40px rgba(0,212,255,0.2);
            position: relative;
            border: 1px solid rgba(0,212,255,0.3);
        }
        .flashcard:hover { box-shadow: 0 20px 50px rgba(0,212,255,0.4); }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard .front, .flashcard .back { backface-visibility: hidden; position: absolute; width: calc(100% - 60px); }
        .flashcard .back { transform: rotateY(180deg); }
        .flashcard .question { font-size: 1.3em; font-weight: 600; line-height: 1.5; }
        .flashcard .answer { font-size: 1.1em; line-height: 1.6; }
        .flashcard .answer-label { color: var(--primary); font-weight: bold; font-size: 0.9em; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; }
        .flashcard .source { margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.85em; color: #888; font-style: italic; }
        .flashcard .tap-hint { position: absolute; bottom: 15px; font-size: 0.8em; color: #666; }
        .card-counter { text-align: center; margin-bottom: 15px; font-size: 0.95em; opacity: 0.8; }
        .quiz-question { background: var(--darker); padding: 25px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--accent); }
        .quiz-question .label { color: var(--accent); font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .quiz-choices { display: flex; flex-direction: column; gap: 12px; }
        .quiz-choice {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            color: var(--light);
            padding: 18px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 1rem;
        }
        .quiz-choice:hover { background: rgba(0,212,255,0.15); border-color: var(--primary); transform: translateX(5px); }
        .quiz-choice.correct { background: rgba(0,255,136,0.2); border-color: var(--success); }
        .quiz-choice.incorrect { background: rgba(255,0,110,0.2); border-color: var(--accent); }
        .quiz-choice.disabled { pointer-events: none; opacity: 0.6; }
        .feedback { padding: 20px; border-radius: 12px; margin-top: 20px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .feedback.correct { background: rgba(0,255,136,0.15); border: 1px solid var(--success); }
        .feedback.incorrect { background: rgba(255,0,110,0.15); border: 1px solid var(--accent); }
        .feedback .title { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
        .feedback.correct .title { color: var(--success); }
        .feedback.incorrect .title { color: var(--accent); }
        .dojo-scenario { background: linear-gradient(135deg, var(--darker), #1a0a2e); padding: 25px; border-radius: 12px; border: 1px solid rgba(255,0,110,0.3); margin-bottom: 20px; }
        .dojo-scenario .context-label { color: var(--accent); font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .dojo-scenario .context { font-size: 1.05em; line-height: 1.7; margin-bottom: 20px; }
        .dojo-scenario .question { background: rgba(255,190,11,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--warning); }
        .impact-badge { display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; margin-left: 10px; }
        .impact-positive { background: var(--success); color: #000; }
        .impact-negative { background: var(--accent); color: #fff; }
        .impact-neutral { background: var(--warning); color: #000; }
        .save-code-section { background: #050510; border: 2px dashed var(--primary); border-radius: 12px; padding: 25px; margin: 25px 0; }
        .save-code-box { background: #000; color: var(--primary); font-family: 'Courier New', monospace; padding: 20px; border-radius: 8px; word-break: break-all; font-size: 0.85em; line-height: 1.5; user-select: all; margin: 15px 0; max-height: 120px; overflow-y: auto; }
        .save-instructions { background: rgba(0,212,255,0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 8px; margin-top: 20px; }
        .save-instructions h4 { color: var(--primary); margin-bottom: 10px; }
        .save-instructions ul { margin-left: 20px; line-height: 1.8; }
        .report { background: linear-gradient(145deg, #1a1a3a, #0a0a1a); border-radius: 15px; overflow: hidden; border: 1px solid rgba(0,212,255,0.3); }
        .report-header { background: linear-gradient(135deg, var(--primary), #0099cc); color: #000; padding: 30px; text-align: center; }
        .report-header h2 { font-size: 1.8em; margin-bottom: 5px; }
        .report-body { padding: 30px; }
        .report-stat { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .report-stat:last-child { border-bottom: none; }
        .report-stat .label { color: #888; }
        .report-stat .value { font-weight: bold; }
        .mastery-badge { display: inline-block; padding: 8px 20px; border-radius: 25px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .mastery-expert { background: linear-gradient(135deg, var(--gold), #cc9900); color: #000; }
        .mastery-confirmed { background: linear-gradient(135deg, var(--primary), #0099cc); color: #000; }
        .mastery-learning { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: #fff; }
        .unlock-section { background: linear-gradient(135deg, #1a0a2e, #0a0a1a); border: 2px solid var(--warning); border-radius: 15px; padding: 30px; text-align: center; margin: 20px 0; }
        .unlock-section h3 { color: var(--warning); margin-bottom: 15px; }
        .unlock-section input { width: 100%; padding: 15px; border: 2px solid #333; border-radius: 8px; background: #050510; color: var(--primary); font-family: 'Courier New', monospace; font-size: 0.9em; margin: 15px 0; }
        .unlock-section input:focus { outline: none; border-color: var(--primary); }
        .error-msg { color: var(--accent); font-weight: bold; margin-top: 10px; }
        .level-indicator { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
        .level-dot { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; background: var(--darker); border: 3px solid #333; transition: all 0.3s; }
        .level-dot.active { border-color: var(--primary); box-shadow: 0 0 20px rgba(0,212,255,0.5); }
        .level-dot.completed { background: var(--success); border-color: var(--success); color: #000; }
        @media (max-width: 600px) { body { padding: 10px; } .app-container { padding: 20px; } .header h1 { font-size: 1.6em; } .flashcard { padding: 25px 20px; min-height: 250px; } .btn { padding: 12px 20px; font-size: 0.9rem; } }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script>
        const MODULE_DATA = {
            id: "JURIDIQUE_03",
            version: "1.0.0",
            titre: "LE SPECTRE NUM√âRIQUE",
            sous_titre: "Pilier 3 : Cyberharc√®lement",
            description: "Ma√Ætriser les sp√©cificit√©s du harc√®lement en ligne : preuves, infractions, et strat√©gies de d√©fense num√©rique.",
            auteur: "Programme pHARe",
            prerequis: "JURIDIQUE_02",
            niveau_difficulte: 3,
            
            niveau1: {
                titre: "Le Terrain Num√©rique",
                type: "flashcards",
                xp_reward: 100,
                cartes: [
                    {
                        recto: "Quelle est la SP√âCIFICIT√â majeure du cyberharc√®lement par rapport au harc√®lement \"classique\" ?",
                        verso: "3 diff√©rences cruciales :\n\n1. ASYNCHRONE : L'attaque continue m√™me quand l'agresseur dort\n\n2. INVISIBLE : Pas de feedback visuel de la souffrance (√©cran = mur)\n\n3. PERMANENT : Les traces restent (screenshots, archives)",
                        source: "Recherches sur le cyberharc√®lement"
                    },
                    {
                        recto: "Quel est le MEILLEUR PR√âDICTEUR du cyberharc√®lement ?",
                        verso: "Le harc√®lement \"hors ligne\" (traditionnel).\n\nLes √©tudes montrent que ceux qui harc√®lent en ligne harc√®lent g√©n√©ralement aussi en pr√©sentiel.\n\nLe cyber n'est pas un monde √† part : c'est une EXTENSION du r√©el.",
                        source: "M√©ta-analyses cyberharc√®lement"
                    },
                    {
                        recto: "Qu'est-ce que le RAID NUM√âRIQUE (ou effet de meute en ligne) ?",
                        verso: "Attaque coordonn√©e o√π de nombreuses personnes ciblent la m√™me victime simultan√©ment.\n\nSur internet, l'anonymat + les algorithmes AMPLIFIENT la polarisation de groupe.\n\nChaque participant peut minimiser son r√¥le : \"J'ai juste envoy√© UN message.\"",
                        source: "Loi 2022 - Effet de meute"
                    },
                    {
                        recto: "Quelles INFRACTIONS NUM√âRIQUES sp√©cifiques peut-on signaler imm√©diatement ?",
                        verso: "‚Ä¢ USURPATION D'IDENTIT√â (Art. 226-4-1) : Faux compte = 1 an + 15 000‚Ç¨\n\n‚Ä¢ REVENGE PORN (Art. 226-2-1) : Diffusion d'images intimes = 2 ans + 60 000‚Ç¨\n\n‚Ä¢ HAPPY SLAPPING : Filmer + diffuser une agression = circonstance aggravante\n\n‚Ä¢ DROIT √Ä L'IMAGE : Publier sans consentement",
                        source: "Code P√©nal"
                    },
                    {
                        recto: "Pourquoi le d√©sengagement moral est-il AMPLIFI√â en ligne ?",
                        verso: "L'√©cran cr√©e une DISTANCE √âMOTIONNELLE :\n\n‚Ä¢ Pas de larmes visibles\n‚Ä¢ Pas de voix tremblante\n‚Ä¢ Pas de langage corporel\n\n‚Üí Le cerveau ne \"connecte\" pas √† la souffrance de l'autre\n‚Üí La DISTORSION DES CONS√âQUENCES est automatique",
                        source: "Psychologie du cyberharc√®lement"
                    },
                    {
                        recto: "Comment S√âCURISER des preuves num√©riques ?",
                        verso: "La R√àGLE D'OR : Screenshot AVANT signalement\n\n1. Capture d'√©cran avec DATE/HEURE visible\n2. URL compl√®te si possible\n3. Profil de l'auteur (avant qu'il ne le supprime)\n4. Contexte (conversation compl√®te)\n\nNe JAMAIS supprimer ou r√©pondre d'abord !",
                        source: "Protocole pHARe num√©rique"
                    }
                ]
            },
            
            niveau2: {
                titre: "Forensique Num√©rique",
                type: "quiz",
                xp_reward: 150,
                questions: [
                    {
                        texte: "Une √©l√®ve te montre des messages Instagram humiliants re√ßus d'un compte anonyme. Elle veut supprimer la conversation pour \"ne plus y penser\".",
                        question: "Que lui conseilles-tu ?",
                        choix: [
                            { txt: "Oui, supprime tout, √ßa te fera du bien", correct: false, feedback: "ERREUR CRITIQUE ! En supprimant, elle d√©truit les PREUVES. Sans preuves, impossible de poursuivre ou de faire agir l'√©tablissement." },
                            { txt: "Non ! Screenshot TOUT d'abord, puis on avise", correct: true, feedback: "PARFAIT ! La r√®gle d'or : capturer AVANT toute action. Date, heure, profil, messages, URL. Ces preuves sont essentielles pour le signalement." },
                            { txt: "Bloque juste le compte, c'est suffisant", correct: false, feedback: "Insuffisant ! Bloquer stoppe les messages mais ne constitue pas une preuve. L'auteur peut aussi cr√©er un nouveau compte. Il faut capturer ET signaler." }
                        ]
                    },
                    {
                        texte: "Un groupe Snapchat a √©t√© cr√©√© sp√©cifiquement pour partager des \"memes\" moqueurs sur un √©l√®ve. Les messages s'auto-d√©truisent.",
                        question: "Quel est le principal d√©fi juridique ?",
                        choix: [
                            { txt: "Snapchat est bas√© aux USA donc la loi fran√ßaise ne s'applique pas", correct: false, feedback: "FAUX ! La loi fran√ßaise s'applique si victime OU auteur est en France. Snapchat coop√®re avec les autorit√©s sur demande judiciaire." },
                            { txt: "L'auto-destruction complique la preuve mais ne l'emp√™che pas", correct: true, feedback: "EXACT ! Snapchat conserve des logs. Les screenshots restent possibles. Et les t√©moins peuvent t√©moigner. L'√©ph√©m√®re n'est pas l'impunit√©." },
                            { txt: "C'est l√©gal car les messages disparaissent", correct: false, feedback: "ABSURDE ! Le caract√®re √©ph√©m√®re ne change RIEN √† l'infraction. Le harc√®lement est constitu√© au moment de l'envoi, pas de la conservation." }
                        ]
                    },
                    {
                        texte: "Plusieurs √©l√®ves ont chacun post√© UN SEUL commentaire n√©gatif sous la photo d'un camarade. Individuellement, rien de grave. Mais il y en a 47.",
                        question: "Comment qualifier juridiquement cette situation ?",
                        choix: [
                            { txt: "Pas de harc√®lement car chacun n'a agi qu'une fois", correct: false, feedback: "FAUX ! C'est l'EFFET DE MEUTE (Loi 2022). La victime subit 47 attaques = r√©p√©tition. Tous les auteurs sont co-responsables de harc√®lement." },
                            { txt: "Harc√®lement par effet de meute - tous co-responsables", correct: true, feedback: "CORRECT ! Depuis 2022, la r√©p√©tition peut venir de la multiplicit√© des auteurs. 47 personnes √ó 1 acte = harc√®lement collectif. Responsabilit√© partag√©e." },
                            { txt: "Seul l'initiateur (le premier commentaire) est responsable", correct: false, feedback: "NON ! Chaque participant a CHOISI de commenter. Pas d'excuse du type \"j'ai suivi\". La loi ne distingue pas premier et dernier." }
                        ]
                    },
                    {
                        texte: "Un √©l√®ve d√©couvre qu'un compte TikTok parodique existe √† son nom avec des vid√©os humiliantes. Le compte a 3 abonn√©s et n'a rien post√© de \"grave\".",
                        question: "Y a-t-il infraction ?",
                        choix: [
                            { txt: "Non, c'est juste une parodie avec peu d'audience", correct: false, feedback: "ERREUR ! L'USURPATION D'IDENTIT√â est constitu√©e d√®s la cr√©ation du compte. Peu importe l'audience ou la \"gravit√©\" du contenu. C'est 1 an + 15 000‚Ç¨." },
                            { txt: "Oui, usurpation d'identit√© num√©rique imm√©diate", correct: true, feedback: "EXACT ! Article 226-4-1 : utiliser l'identit√© d'autrui pour troubler sa tranquillit√© est un D√âLIT. Pas besoin d'attendre du contenu grave. Le compte lui-m√™me est l'infraction." },
                            { txt: "Il faut attendre qu'il y ait du contenu vraiment blessant", correct: false, feedback: "DANGEREUX ! Attendre = laisser l'infraction s'aggraver. L'usurpation est d√©j√† constitu√©e. Agir MAINTENANT permet de stopper avant l'escalade." }
                        ]
                    }
                ]
            },
            
            niveau3: {
                titre: "Cyber-Op√©rations",
                type: "dojo",
                xp_reward: 200,
                scenarios: [
                    {
                        contexte: "Un √©l√®ve de 4√®me te confie qu'il re√ßoit des photos intimes d'une camarade, envoy√©es par un tiers sans le consentement de la fille. Il ne les a pas demand√©es mais les a re√ßues.",
                        question: "Quelle est sa situation juridique ET que doit-il faire ?",
                        choix: [
                            { txt: "Il n'est pas responsable puisqu'il n'a rien demand√©", impact: 20, level: "partial", feedback: "ATTENTION ! S'il conserve ou transf√®re ces images, il devient CO-AUTEUR de la diffusion. Sa responsabilit√© d√©pend de ce qu'il fait MAINTENANT." },
                            { txt: "Il doit supprimer imm√©diatement et signaler √† un adulte", impact: 100, level: "optimal", feedback: "PARFAIT ! Ne pas conserver (√©vite la complicit√©), signaler (prot√®ge la victime), ne pas transf√©rer (stoppe la diffusion). C'est la seule r√©ponse √©thique ET l√©gale." },
                            { txt: "Il doit les montrer √† la victime pour qu'elle sache", impact: -30, level: "error", feedback: "CATASTROPHIQUE ! Montrer √† la victime = nouvelle diffusion = infraction. Il doit pr√©venir un adulte qui g√©rera avec tact." }
                        ]
                    },
                    {
                        contexte: "Une story Instagram montre une bagarre dans la cour avec commentaire moqueur sur la victime. La story a d√©j√† 200 vues et va expirer dans 2 heures. Tu la vois par hasard.",
                        question: "Priorisation : que fais-tu EN PREMIER ?",
                        choix: [
                            { txt: "Je signale √† Instagram pour qu'ils suppriment", impact: 30, level: "partial", feedback: "Utile mais PAS prioritaire. Instagram mettra des heures/jours √† traiter. Pendant ce temps, la story continue de circuler ET la preuve risque de dispara√Ætre." },
                            { txt: "Je screenshot d'abord, puis je signale √† un adulte r√©f√©rent", impact: 100, level: "optimal", feedback: "OPTIMAL ! 1) Capturer la preuve AVANT expiration 2) Signaler √† l'adulte qui actionnera les leviers institutionnels. Tu s√©curises ET tu agis." },
                            { txt: "J'attends qu'elle expire, √ßa √©vitera de faire des vagues", impact: -40, level: "error", feedback: "COMPLICIT√â PASSIVE ! Ne rien faire = permettre la diffusion. De plus, la preuve dispara√Æt et l'impunit√© encourage la r√©cidive." }
                        ]
                    },
                    {
                        contexte: "Tu d√©couvres un serveur Discord \"priv√©\" o√π des √©l√®ves de ton coll√®ge classent leurs camarades par \"beaut√©\" avec des photos vol√©es. Tu n'en fais pas partie mais un ami t'en a parl√©.",
                        question: "Quelle cha√Æne d'action recommandes-tu ?",
                        choix: [
                            { txt: "Demander √† mon ami de screenshot puis confronter directement les cr√©ateurs", impact: 10, level: "partial", feedback: "RISQU√â ! Confronter directement peut : 1) Les alerter (suppression des preuves) 2) Te cibler comme \"balance\". Passe par les adultes." },
                            { txt: "Signaler au CPE avec le maximum d'infos (nom du serveur, participants connus)", impact: 100, level: "optimal", feedback: "EXCELLENT ! Tu donnes les √©l√©ments pour une enqu√™te interne. Le CPE peut saisir les autorit√©s si n√©cessaire. Tu ne t'exposes pas et tu agis efficacement." },
                            { txt: "Ne rien faire car je n'en fais pas partie", impact: -50, level: "error", feedback: "NON-ASSISTANCE ! Tu as connaissance d'infractions multiples (droit √† l'image, potentiel harc√®lement). Le silence = complicit√© morale. Agir prot√®ge les victimes." }
                        ]
                    }
                ]
            }
        };

        const generateSaveCode = (progress) => {
            const payload = { v: 1, d: new Date().toISOString(), m: MODULE_DATA.id, mv: MODULE_DATA.version, n: progress.nom || "Anonyme", c: progress.classe || "", l: progress.currentLevel, s: progress.score, x: progress.xp, q: progress.quizScore, dj: progress.dojoScore, f: progress.finished };
            return btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        };

        const decodeSaveCode = (code) => {
            try { return { valid: true, data: JSON.parse(decodeURIComponent(escape(atob(code.trim())))) }; }
            catch (e) { return { valid: false, error: "Code invalide." }; }
        };

        const verifyPrerequisite = (code) => {
            const result = decodeSaveCode(code);
            if (!result.valid) return { valid: false, error: "Code invalide." };
            if (result.data.m !== MODULE_DATA.prerequis) return { valid: false, error: `Ce code provient du module ${result.data.m}, pas du module ${MODULE_DATA.prerequis}.` };
            if (!result.data.f) return { valid: false, error: "Ce module n'a pas √©t√© termin√©." };
            return { valid: true, data: result.data };
        };

        const e = React.createElement;
        const { useState } = React;

        function Header({ showProgress, xp }) {
            return e('div', { className: 'header' },
                e('div', { className: 'level-badge' }, `NIVEAU ${MODULE_DATA.niveau_difficulte}`),
                e('h1', null, MODULE_DATA.titre),
                e('div', { className: 'subtitle' }, MODULE_DATA.sous_titre),
                showProgress && e('div', { style: { marginTop: '10px' } }, e('span', { className: 'xp-badge' }, `‚ö° ${xp} XP`))
            );
        }

        function ProgressBar({ currentLevel, xp }) {
            const percent = Math.min(100, (currentLevel / 3) * 100);
            return e('div', { className: 'progress-container' },
                e('div', { className: 'progress-stats' }, e('span', null, `Niveau ${currentLevel}/3`), e('span', { className: 'xp-badge' }, `${xp} XP`)),
                e('div', { className: 'progress-bar-outer' }, e('div', { className: 'progress-bar-inner', style: { width: `${percent}%` } }))
            );
        }

        function LevelIndicator({ current }) {
            const levels = ['üì°', 'üîç', 'üéØ'];
            return e('div', { className: 'level-indicator' }, levels.map((emoji, i) => e('div', { key: i, className: `level-dot ${i + 1 === current ? 'active' : ''} ${i + 1 < current ? 'completed' : ''}` }, i + 1 < current ? '‚úì' : emoji)));
        }

        function Flashcard({ card, onNext, isLast, onComplete }) {
            const [flipped, setFlipped] = useState(false);
            return e('div', { className: 'flashcard-container' },
                e('div', { className: `flashcard ${flipped ? 'flipped' : ''}`, onClick: () => setFlipped(!flipped) },
                    e('div', { className: 'front' }, e('div', { className: 'question', style: { whiteSpace: 'pre-line' } }, card.recto), e('div', { className: 'tap-hint' }, 'üëÜ Clique pour retourner')),
                    e('div', { className: 'back' }, e('div', { className: 'answer-label' }, '‚úì R√©ponse'), e('div', { className: 'answer', style: { whiteSpace: 'pre-line' } }, card.verso), e('div', { className: 'source' }, `üìñ ${card.source}`))
                ),
                e('div', { className: 'text-center', style: { marginTop: '20px' } },
                    flipped && (isLast ? e('button', { className: 'btn btn-success', onClick: onComplete }, '‚úì VALIDER') : e('button', { className: 'btn', onClick: () => { onNext(); setFlipped(false); } }, 'SUIVANT ‚Üí'))
                )
            );
        }

        function QuizQuestion({ question, onAnswer }) {
            const [answered, setAnswered] = useState(false);
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const handleChoice = (choice, idx) => { if (answered) return; setAnswered(true); setSelectedIdx(idx); setFeedback({ correct: choice.correct, text: choice.feedback }); };
            return e('div', null,
                e('div', { className: 'quiz-question' }, e('div', { className: 'label' }, 'üíª SITUATION'), e('p', { style: { marginBottom: '15px', lineHeight: '1.6' } }, question.texte), question.question && e('p', { style: { fontWeight: 'bold', color: '#ff006e' } }, `‚ùì ${question.question}`)),
                e('div', { className: 'quiz-choices' }, question.choix.map((choice, idx) => e('button', { key: idx, className: `quiz-choice ${answered ? (idx === selectedIdx ? (choice.correct ? 'correct' : 'incorrect') : 'disabled') : ''}`, onClick: () => handleChoice(choice, idx), disabled: answered }, choice.txt))),
                feedback && e('div', { className: `feedback ${feedback.correct ? 'correct' : 'incorrect'}` }, e('div', { className: 'title' }, feedback.correct ? '‚úì CORRECT !' : '‚úó ERREUR DE PROTOCOLE'), e('p', null, feedback.text), e('button', { className: 'btn', style: { marginTop: '20px' }, onClick: () => onAnswer(feedback.correct) }, 'CONTINUER ‚Üí'))
            );
        }

        function DojoScenario({ scenario, onAnswer }) {
            const [answered, setAnswered] = useState(false);
            const [selectedChoice, setSelectedChoice] = useState(null);
            const handleChoice = (choice) => { if (answered) return; setAnswered(true); setSelectedChoice(choice); };
            const getImpactClass = (impact) => impact >= 80 ? 'impact-positive' : impact > 0 ? 'impact-neutral' : 'impact-negative';
            const getImpactLabel = (impact) => impact >= 0 ? `+${impact}` : `${impact}`;
            return e('div', null,
                e('div', { className: 'dojo-scenario' }, e('div', { className: 'context-label' }, 'üéÆ CYBER-OP√âRATION'), e('p', { className: 'context' }, scenario.contexte), e('div', { className: 'question' }, e('strong', null, '‚ùì ', scenario.question))),
                e('div', { className: 'quiz-choices' }, scenario.choix.map((choice, idx) => e('button', { key: idx, className: `quiz-choice ${answered ? (choice === selectedChoice ? (choice.level === 'optimal' ? 'correct' : choice.level === 'error' ? 'incorrect' : '') : 'disabled') : ''}`, onClick: () => handleChoice(choice), disabled: answered }, choice.txt, answered && e('span', { className: `impact-badge ${getImpactClass(choice.impact)}` }, getImpactLabel(choice.impact))))),
                selectedChoice && e('div', { className: `feedback ${selectedChoice.level === 'optimal' ? 'correct' : selectedChoice.level === 'error' ? 'incorrect' : 'correct'}` }, e('div', { className: 'title' }, selectedChoice.level === 'optimal' ? 'üéØ OP√âRATION R√âUSSIE !' : selectedChoice.level === 'error' ? '‚ö†Ô∏è FAILLE DE S√âCURIT√â' : 'üëç ACCEPTABLE'), e('p', null, selectedChoice.feedback), e('button', { className: 'btn', style: { marginTop: '20px' }, onClick: () => onAnswer(selectedChoice.impact) }, 'CONTINUER ‚Üí'))
            );
        }

        function Report({ progress, onRestart, onMenu }) {
            const saveCode = generateSaveCode(progress);
            const [copied, setCopied] = useState(false);
            const copyToClipboard = () => { navigator.clipboard.writeText(saveCode).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }); };
            const getMasteryLevel = () => { const total = progress.quizScore + progress.dojoScore; if (total >= 450) return { label: 'EXPERT', class: 'mastery-expert' }; if (total >= 280) return { label: 'CONFIRM√â', class: 'mastery-confirmed' }; return { label: 'EN FORMATION', class: 'mastery-learning' }; };
            const mastery = getMasteryLevel();
            return e('div', null,
                e('div', { className: 'report' },
                    e('div', { className: 'report-header' }, e('span', { style: { fontSize: '3em', display: 'block', marginBottom: '15px' } }, 'üì°'), e('h2', null, 'MODULE 3 COMPL√âT√â'), e('p', null, MODULE_DATA.titre)),
                    e('div', { className: 'report-body' },
                        e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'Agent'), e('span', { className: 'value' }, progress.nom || 'Anonyme')),
                        progress.classe && e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'Classe'), e('span', { className: 'value' }, progress.classe)),
                        e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'XP Total'), e('span', { className: 'value' }, `${progress.xp} XP`)),
                        e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'Score Quiz'), e('span', { className: 'value' }, `${progress.quizScore} pts`)),
                        e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'Score Cyber-Ops'), e('span', { className: 'value' }, `${progress.dojoScore} pts`)),
                        e('div', { className: 'report-stat' }, e('span', { className: 'label' }, 'Ma√Ætrise'), e('span', { className: `mastery-badge ${mastery.class}` }, mastery.label))
                    )
                ),
                e('div', { className: 'save-code-section' },
                    e('h3', { style: { color: '#00d4ff', marginBottom: '15px' } }, 'üíæ CODE DE SAUVEGARDE'),
                    e('p', { style: { opacity: 0.8 } }, 'Ce code d√©bloque le MODULE 4 !'),
                    e('div', { className: 'save-code-box' }, saveCode),
                    e('button', { className: `btn ${copied ? 'btn-success' : ''}`, onClick: copyToClipboard }, copied ? '‚úì COPI√â !' : 'üìã COPIER'),
                    e('div', { className: 'save-instructions' }, e('h4', null, 'üîì Prochaine √©tape'), e('ul', null, e('li', null, 'Ce code d√©bloque le Module 4 : "Le Protocole pHARe"'), e('li', null, 'Envoie-le aussi au CPE pour valider ta progression')))
                ),
                e('div', { className: 'btn-group' }, e('button', { className: 'btn btn-secondary', onClick: onMenu }, 'üè† MENU'), e('button', { className: 'btn btn-warning', onClick: onRestart }, 'üîÑ RECOMMENCER'))
            );
        }

        function App() {
            const [mode, setMode] = useState('menu');
            const [unlocked, setUnlocked] = useState(false);
            const [currentLevel, setCurrentLevel] = useState(1);
            const [cardIdx, setCardIdx] = useState(0);
            const [questionIdx, setQuestionIdx] = useState(0);
            const [scenarioIdx, setScenarioIdx] = useState(0);
            const [xp, setXp] = useState(0);
            const [quizScore, setQuizScore] = useState(0);
            const [dojoScore, setDojoScore] = useState(0);
            const [nom, setNom] = useState('');
            const [classe, setClasse] = useState('');
            const [unlockCode, setUnlockCode] = useState('');
            const [unlockError, setUnlockError] = useState('');

            const resetProgress = () => { setCurrentLevel(1); setCardIdx(0); setQuestionIdx(0); setScenarioIdx(0); setXp(0); setQuizScore(0); setDojoScore(0); };
            const progress = { nom, classe, currentLevel, xp, quizScore, dojoScore, score: quizScore + dojoScore, finished: mode === 'report' };

            const handleUnlock = () => {
                const result = verifyPrerequisite(unlockCode);
                if (result.valid) { setNom(result.data.n || ''); setClasse(result.data.c || ''); setUnlocked(true); setUnlockError(''); }
                else { setUnlockError(result.error); }
            };

            if (mode === 'menu') {
                return e('div', { className: 'app-container' },
                    e(Header, { showProgress: false }),
                    e('div', { className: 'card' }, e('strong', null, 'üéØ MISSION : '), MODULE_DATA.description),
                    !unlocked ? e('div', { className: 'unlock-section' },
                        e('h3', null, 'üîê MODULE VERROUILL√â'),
                        e('p', null, `Pr√©requis : Compl√©ter "${MODULE_DATA.prerequis}"`),
                        e('input', { type: 'text', placeholder: 'Code du Module 2...', value: unlockCode, onChange: (ev) => { setUnlockCode(ev.target.value); setUnlockError(''); } }),
                        unlockError && e('div', { className: 'error-msg' }, `‚ö†Ô∏è ${unlockError}`),
                        e('button', { className: 'btn', onClick: handleUnlock }, 'üîì D√âBLOQUER')
                    ) : e('div', { className: 'btn-group' },
                        e('div', { style: { textAlign: 'center', color: '#00ff88', marginBottom: '10px' } }, `‚úì Bienvenue ${nom} !`),
                        e('button', { className: 'btn btn-block', onClick: () => setMode('game') }, '‚ñ∂Ô∏è COMMENCER')
                    ),
                    e('div', { style: { marginTop: '30px', textAlign: 'center', opacity: 0.5, fontSize: '0.85em' } }, `Module ${MODULE_DATA.id} v${MODULE_DATA.version}`)
                );
            }

            if (mode === 'game') {
                if (currentLevel === 1) {
                    const cards = MODULE_DATA.niveau1.cartes;
                    return e('div', { className: 'app-container' },
                        e(Header, { showProgress: true, xp }),
                        e(ProgressBar, { currentLevel, xp }),
                        e(LevelIndicator, { current: currentLevel }),
                        e('h2', { style: { textAlign: 'center' } }, 'üì° NIVEAU 1 : TH√âORIE'),
                        e('div', { className: 'card-counter' }, `Carte ${cardIdx + 1} / ${cards.length}`),
                        e(Flashcard, { card: cards[cardIdx], isLast: cardIdx === cards.length - 1, onNext: () => setCardIdx(cardIdx + 1), onComplete: () => { setXp(xp + MODULE_DATA.niveau1.xp_reward); setCurrentLevel(2); setCardIdx(0); } })
                    );
                }
                if (currentLevel === 2) {
                    const questions = MODULE_DATA.niveau2.questions;
                    const handleQuizAnswer = (correct) => { if (correct) setQuizScore(quizScore + 35); if (questionIdx < questions.length - 1) setQuestionIdx(questionIdx + 1); else { setXp(xp + MODULE_DATA.niveau2.xp_reward); setCurrentLevel(3); setQuestionIdx(0); } };
                    return e('div', { className: 'app-container' },
                        e(Header, { showProgress: true, xp }),
                        e(ProgressBar, { currentLevel, xp }),
                        e(LevelIndicator, { current: currentLevel }),
                        e('h2', { style: { textAlign: 'center' } }, 'üîç NIVEAU 2 : FORENSIQUE'),
                        e('div', { className: 'card-counter' }, `Question ${questionIdx + 1} / ${questions.length}`),
                        e(QuizQuestion, { key: questionIdx, question: questions[questionIdx], onAnswer: handleQuizAnswer })
                    );
                }
                if (currentLevel === 3) {
                    const scenarios = MODULE_DATA.niveau3.scenarios;
                    const handleDojoAnswer = (impact) => { setDojoScore(dojoScore + Math.max(0, impact)); if (scenarioIdx < scenarios.length - 1) setScenarioIdx(scenarioIdx + 1); else { setXp(xp + MODULE_DATA.niveau3.xp_reward); setMode('report'); } };
                    return e('div', { className: 'app-container' },
                        e(Header, { showProgress: true, xp }),
                        e(ProgressBar, { currentLevel, xp }),
                        e(LevelIndicator, { current: currentLevel }),
                        e('h2', { style: { textAlign: 'center' } }, 'üéØ NIVEAU 3 : CYBER-OPS'),
                        e('div', { className: 'card-counter' }, `Mission ${scenarioIdx + 1} / ${scenarios.length}`),
                        e(DojoScenario, { key: scenarioIdx, scenario: scenarios[scenarioIdx], onAnswer: handleDojoAnswer })
                    );
                }
            }

            if (mode === 'report') {
                return e('div', { className: 'app-container' },
                    e(Report, { progress: { ...progress, xp: xp + (currentLevel > 3 ? 0 : MODULE_DATA.niveau3.xp_reward) }, onRestart: () => { resetProgress(); setMode('game'); }, onMenu: () => { resetProgress(); setUnlocked(false); setUnlockCode(''); setMode('menu'); } })
                );
            }
            return e('div', { className: 'app-container' }, 'Chargement...');
        }

        ReactDOM.createRoot(document.getElementById('root')).render(e(App));
    </script>
</body>
</html>
