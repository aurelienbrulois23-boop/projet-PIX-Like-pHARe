<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIX-pHARe | DE LA TOL√âRANCE √Ä LA LOI</title>
    <style>
        :root {
            --primary: #FFC400;   /* Ambre */
            --accent: #9C7C38;    /* S√©pia n√©on */
            --success: #B08D57;   /* Bronze */
            --warning: #FAF3E3;   /* Vieux Papier lumineux */
            --dark: #2C2210;      /* S√©pia fonc√© */
            --darker: #B08D57;
            --card: #F2E3C6;      /* Papier jauni */
            --light: #FAF3E3;
            --gold: #FFC400;
        }
        /* ... tout le CSS du module juridique, inchang√© ... */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--light) 0%, var(--warning) 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .app-container {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(176, 141, 87, 0.20), 0 0 0 1px rgba(255,196,0,0.1);
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        .app-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--success), var(--accent));
        }
        /* ... (reproduis ici l'int√©gralit√© des styles du module 01/02/03 pour un rendu 100% identique) ... */
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script>
        // ==== DATA MODULE HISTOIRE_04 ====
        const MODULE_DATA = {
            id: "HISTOIRE_04",
            version: "1.0.0",
            titre: "DE LA TOL√âRANCE √Ä LA LOI",
            sous_titre: "Quand la soci√©t√© commence √† r√©agir",
            description: "Comprendre comment le harc√®lement devient progressivement un probl√®me public, m√©diatique et institutionnel, appelant des r√©ponses collectives.",
            auteur: "Programme pHARe",
            niveau1: {
                titre: "La reconnaissance institutionnelle",
                type: "flashcards",
                xp_reward: 50,
                cartes: [
                    {
                        recto: "Quand le harc√®lement devient-il un probl√®me public ?",
                        verso: "Lorsqu‚Äôil d√©passe le cadre individuel pour √™tre reconnu comme un enjeu de soci√©t√©.\n\nLes m√©dias, les familles et les institutions commencent √† s‚Äôen emparer.",
                        source: "Histoire sociale contemporaine"
                    },
                    {
                        recto: "Quel r√¥le jouent les m√©dias ?",
                        verso: "Ils rendent visibles des situations jusque-l√† silencieuses.\n\nLes t√©moignages et les faits divers provoquent une prise de conscience collective.",
                        source: "Analyse m√©diatique"
                    },
                    {
                        recto: "Pourquoi l‚Äô√âtat s‚Äôimplique-t-il ?",
                        verso: "Parce que l‚Äô√©cole est une institution publique.\n\nGarantir la s√©curit√© et la dignit√© des √©l√®ves devient une responsabilit√© politique.",
                        source: "Politiques publiques √©ducatives"
                    },
                    {
                        recto: "Que signifie la reconnaissance institutionnelle ?",
                        verso: "Elle implique des textes officiels, des circulaires, des dispositifs.\n\nLe probl√®me est d√©sormais nomm√©, encadr√© et suivi.",
                        source: "Fonctionnement institutionnel"
                    },
                    {
                        recto: "Que change cette reconnaissance pour les victimes ?",
                        verso: "Leur parole devient l√©gitime.\n\nElles ne sont plus seules face √† la situation.",
                        source: "Approche psychosociale"
                    }
                ]
            },
            niveau2: {
                titre: "Du silence √† l‚Äôaction",
                type: "quiz",
                xp_reward: 100,
                questions: [
                    {
                        texte: "Un cas de harc√®lement est m√©diatis√© et suscite une forte √©motion.",
                        question: "Quel est l‚Äôeffet principal de cette m√©diatisation ?",
                        choix: [
                            {
                                txt: "Elle transforme un probl√®me individuel en enjeu collectif.",
                                correct: true,
                                feedback: "Exact. La m√©diatisation acc√©l√®re la prise de conscience sociale."
                            },
                            {
                                txt: "Elle r√®gle imm√©diatement toutes les situations.",
                                correct: false,
                                feedback: "Non. Elle ouvre le d√©bat mais ne suffit pas √† elle seule."
                            }
                        ]
                    },
                    {
                        texte: "L‚Äôinstitution scolaire publie des textes officiels.",
                        question: "Quel est leur objectif principal ?",
                        choix: [
                            {
                                txt: "Donner un cadre commun d‚Äôaction.",
                                correct: true,
                                feedback: "Correct. Ces textes permettent des r√©ponses coh√©rentes et coordonn√©es."
                            },
                            {
                                txt: "Sanctionner automatiquement tous les √©l√®ves.",
                                correct: false,
                                feedback: "Non. Ils visent d‚Äôabord la pr√©vention et la protection."
                            }
                        ]
                    },
                    {
                        texte: "Des adultes h√©sitent encore √† intervenir.",
                        question: "Pourquoi cette p√©riode est-elle une phase de transition ?",
                        choix: [
                            {
                                txt: "Les pratiques √©voluent plus lentement que les textes.",
                                correct: true,
                                feedback: "Exact. Le changement culturel prend du temps."
                            },
                            {
                                txt: "Les textes sont inutiles.",
                                correct: false,
                                feedback: "Faux. Ils sont n√©cessaires mais doivent √™tre appropri√©s."
                            }
                        ]
                    }
                ]
            },
            niveau3: {
                titre: "Responsabilit√© collective",
                type: "dojo",
                xp_reward: 150,
                scenarios: [
                    {
                        contexte: "Un √©tablissement commence √† reconna√Ætre officiellement des situations de harc√®lement.",
                        question: "Quelle est la priorit√© institutionnelle ?",
                        choix: [
                            {
                                txt: "Prot√©ger les √©l√®ves et agir rapidement.",
                                impact: 100,
                                level: "optimal",
                                feedback: "Exact. La protection des √©l√®ves devient centrale."
                            },
                            {
                                txt: "Attendre que les situations se r√®glent seules.",
                                impact: -30,
                                level: "error",
                                feedback: "Erreur. L‚Äôinaction est d√©sormais reconnue comme probl√©matique."
                            },
                            {
                                txt: "D√©l√©guer uniquement aux familles concern√©es.",
                                impact: -40,
                                level: "error",
                                feedback: "Non. La r√©ponse est d√©sormais collective et institutionnelle."
                            }
                        ]
                    },
                    {
                        contexte: "Un adulte h√©site √† intervenir malgr√© un cadre officiel.",
                        question: "Que permet la loi ?",
                        choix: [
                            {
                                txt: "Elle oblige √† agir et prot√®ge les intervenants.",
                                impact: 80,
                                level: "good",
                                feedback: "Oui. Le cadre l√©gal donne des outils et des garanties."
                            },
                            {
                                txt: "Elle interdit toute intervention.",
                                impact: -20,
                                level: "error",
                                feedback: "Faux. Elle impose une responsabilit√©."
                            },
                            {
                                txt: "Elle ne change rien aux pratiques.",
                                impact: -40,
                                level: "error",
                                feedback: "Erreur. La loi vise justement √† faire √©voluer les pratiques."
                            }
                        ]
                    }
                ]
            }
        };
        // ============================================================
        // UTILITAIRES DE SAUVEGARDE
        // ============================================================
        const generateSaveCode = (progress) => {
            const payload = {
                v: 1, // version du format
                d: new Date().toISOString(),
                m: MODULE_DATA.id,
                mv: MODULE_DATA.version,
                n: progress.nom || "Anonyme",
                c: progress.classe || "",
                l: progress.currentLevel,
                s: progress.score,
                x: progress.xp,
                q: progress.quizScore,
                dj: progress.dojoScore,
                f: progress.finished
            };
            return btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        };

        const decodeSaveCode = (code) => {
            try {
                const data = JSON.parse(decodeURIComponent(escape(atob(code.trim()))));
                if (data.m !== MODULE_DATA.id) return { valid: false, error: "Ce code est pour un autre module." };
                return { valid: true, data };
            } catch (e) {
                return { valid: false, error: "Code invalide ou corrompu." };
            }
        };

        const formatDate = (isoString) => {
            return new Date(isoString).toLocaleDateString('fr-FR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        };

        // ============================================================
        // COMPOSANTS REACT (sans JSX - compatible navigateur)
        // ============================================================
        const e = React.createElement;
        const { useState, useEffect } = React;

        // --- Header Component ---
        function Header({ showProgress, xp, currentLevel }) {
            return e('div', { className: 'header' },
                e('h1', null, MODULE_DATA.titre),
                e('div', { className: 'subtitle' }, MODULE_DATA.sous_titre),
                showProgress && e('div', { className: 'badge' }, `‚ö° ${xp} XP`)
            );
        }

        // --- Progress Bar Component ---
        function ProgressBar({ currentLevel, xp }) {
            const totalLevels = 3;
            const percent = Math.min(100, (currentLevel / totalLevels) * 100);
            
            return e('div', { className: 'progress-container' },
                e('div', { className: 'progress-stats' },
                    e('span', null, `Niveau ${currentLevel}/3`),
                    e('span', { className: 'xp-badge' }, `${xp} XP`)
                ),
                e('div', { className: 'progress-bar-outer' },
                    e('div', { className: 'progress-bar-inner', style: { width: `${percent}%` } })
                )
            );
        }

        // --- Level Indicator Component ---
        function LevelIndicator({ current }) {
            const levels = ['üìö', 'üîç', '‚öîÔ∏è'];
            return e('div', { className: 'level-indicator' },
                levels.map((emoji, i) => 
                    e('div', { 
                        key: i,
                        className: `level-dot ${i + 1 === current ? 'active' : ''} ${i + 1 < current ? 'completed' : ''}`
                    }, i + 1 < current ? '‚úì' : emoji)
                )
            );
        }

        // --- Flashcard Component ---
        function Flashcard({ card, onNext, isLast, onComplete }) {
            const [flipped, setFlipped] = useState(false);
            
            return e('div', { className: 'flashcard-container' },
                e('div', { 
                    className: `flashcard ${flipped ? 'flipped' : ''}`,
                    onClick: () => setFlipped(!flipped)
                },
                    e('div', { className: 'front' },
                        e('div', { className: 'question' }, card.recto),
                        e('div', { className: 'tap-hint' }, 'üëÜ Clique pour retourner')
                    ),
                    e('div', { className: 'back' },
                        e('div', { className: 'answer-label' }, '‚úì R√©ponse'),
                        e('div', { className: 'answer', style: { whiteSpace: 'pre-line' } }, card.verso),
                        e('div', { className: 'source' }, `üìñ ${card.source}`)
                    )
                ),
                e('div', { className: 'text-center mt-20' },
                    flipped && (
                        isLast 
                            ? e('button', { className: 'btn btn-success', onClick: onComplete }, '‚úì VALIDER LE NIVEAU 1')
                            : e('button', { className: 'btn', onClick: () => { onNext(); setFlipped(false); } }, 'CARTE SUIVANTE ‚Üí')
                    )
                )
            );
        }

        // --- Quiz Component ---
        function QuizQuestion({ question, onAnswer }) {
            const [answered, setAnswered] = useState(false);
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [feedback, setFeedback] = useState(null);

            const handleChoice = (choice, idx) => {
                if (answered) return;
                setAnswered(true);
                setSelectedIdx(idx);
                setFeedback({ correct: choice.correct, text: choice.feedback });
            };

            const handleNext = () => {
                onAnswer(feedback.correct);
            };

            return e('div', null,
                e('div', { className: 'quiz-question' },
                    e('div', { className: 'label' }, 'üìã SITUATION'),
                    e('p', { style: { marginBottom: '15px', lineHeight: '1.6' } }, question.texte),
                    question.question && e('p', { style: { fontWeight: 'bold', color: '#f39c12' } }, `‚ùì ${question.question}`)
                ),
                e('div', { className: 'quiz-choices' },
                    question.choix.map((choice, idx) => 
                        e('button', {
                            key: idx,
                            className: `quiz-choice ${answered ? (idx === selectedIdx ? (choice.correct ? 'correct' : 'incorrect') : 'disabled') : ''}`,
                            onClick: () => handleChoice(choice, idx),
                            disabled: answered
                        }, choice.txt)
                    )
                ),
                feedback && e('div', { className: `feedback ${feedback.correct ? 'correct' : 'incorrect'}` },
                    e('div', { className: 'title' }, feedback.correct ? '‚úì CORRECT !' : '‚úó ERREUR D\'ANALYSE'),
                    e('p', null, feedback.text),
                    e('button', { className: 'btn mt-20', onClick: handleNext }, 'CONTINUER ‚Üí')
                )
            );
        }

        // --- Dojo Component ---
        function DojoScenario({ scenario, onAnswer }) {
            const [answered, setAnswered] = useState(false);
            const [selectedChoice, setSelectedChoice] = useState(null);

            const handleChoice = (choice) => {
                if (answered) return;
                setAnswered(true);
                setSelectedChoice(choice);
            };

            const getImpactClass = (impact) => {
                if (impact >= 80) return 'impact-positive';
                if (impact > 0) return 'impact-neutral';
                return 'impact-negative';
            };

            const getImpactLabel = (impact) => {
                if (impact >= 80) return `+${impact} pts`;
                if (impact > 0) return `+${impact} pts`;
                return `${impact} pts`;
            };

            return e('div', null,
                e('div', { className: 'dojo-scenario' },
                    e('div', { className: 'context-label' }, 'üé¨ SC√âNARIO'),
                    e('p', { className: 'context' }, scenario.contexte),
                    e('div', { className: 'question' },
                        e('strong', null, '‚ùì ', scenario.question)
                    )
                ),
                e('div', { className: 'quiz-choices' },
                    scenario.choix.map((choice, idx) => 
                        e('button', {
                            key: idx,
                            className: `quiz-choice ${answered ? (choice === selectedChoice ? (choice.level === 'optimal' ? 'correct' : choice.level === 'error' ? 'incorrect' : '') : 'disabled') : ''}`,
                            onClick: () => handleChoice(choice),
                            disabled: answered
                        }, 
                            choice.txt,
                            answered && e('span', { className: `impact-badge ${getImpactClass(choice.impact)}` }, getImpactLabel(choice.impact))
                        )
                    )
                ),
                selectedChoice && e('div', { className: `feedback ${selectedChoice.level === 'optimal' ? 'correct' : selectedChoice.level === 'error' ? 'incorrect' : 'correct'}` },
                    e('div', { className: 'title' }, 
                        selectedChoice.level === 'optimal' ? 'üèÜ D√âCISION OPTIMALE !' : 
                        selectedChoice.level === 'error' ? '‚ö†Ô∏è D√âCISION RISQU√âE' : 'üëç BONNE PISTE'
                    ),
                    e('p', null, selectedChoice.feedback),
                    e('button', { className: 'btn mt-20', onClick: () => onAnswer(selectedChoice.impact) }, 'CONTINUER ‚Üí')
                )
            );
        }

        // --- Report Component ---
        function Report({ progress, onRestart, onMenu }) {
            const saveCode = generateSaveCode(progress);
            const [copied, setCopied] = useState(false);

            const copyToClipboard = () => {
                navigator.clipboard.writeText(saveCode).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                });
            };

            const getMasteryLevel = () => {
                const total = progress.quizScore + progress.dojoScore;
                if (total >= 500) return { label: 'EXPERT', class: 'mastery-expert' };
                if (total >= 300) return { label: 'CONFIRM√â', class: 'mastery-confirmed' };
                return { label: 'EN FORMATION', class: 'mastery-learning' };
            };

            const mastery = getMasteryLevel();

            return e('div', null,
                e('div', { className: 'report' },
                    e('div', { className: 'report-header' },
                        e('span', { className: 'emoji-big' }, 'üèÖ'),
                        e('h2', null, 'MISSION ACCOMPLIE'),
                        e('p', null, MODULE_DATA.titre)
                    ),
                    e('div', { className: 'report-body' },
                        e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'Agent'),
                            e('span', { className: 'value' }, progress.nom || 'Anonyme')
                        ),
                        progress.classe && e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'Classe'),
                            e('span', { className: 'value' }, progress.classe)
                        ),
                        e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'XP Total'),
                            e('span', { className: 'value' }, `${progress.xp} XP`)
                        ),
                        e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'Score Quiz'),
                            e('span', { className: 'value' }, `${progress.quizScore} pts`)
                        ),
                        e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'Score Dojo'),
                            e('span', { className: 'value' }, `${progress.dojoScore} pts`)
                        ),
                        e('div', { className: 'report-stat' },
                            e('span', { className: 'label' }, 'Niveau de Ma√Ætrise'),
                            e('span', { className: `mastery-badge ${mastery.class}` }, mastery.label)
                        )
                    )
                ),
                e('div', { className: 'save-code-section' },
                    e('h3', { style: { color: '#0f0', marginBottom: '15px' } }, 'üíæ CODE DE SAUVEGARDE'),
                    e('p', { style: { opacity: 0.8, marginBottom: '10px' } }, 
                        'Ce code contient ta progression. Conserve-le pr√©cieusement !'
                    ),
                    e('div', { className: 'save-code-box' }, saveCode),
                    e('button', { 
                        className: `btn ${copied ? 'btn-success' : ''}`,
                        onClick: copyToClipboard 
                    }, copied ? '‚úì COPI√â !' : 'üìã COPIER LE CODE'),
                    e('div', { className: 'save-instructions' },
                        e('h4', null, 'üìå Que faire avec ce code ?'),
                        e('ul', null,
                            e('li', null, '1. GARDE-LE pour reprendre plus tard au m√™me niveau'),
                            e('li', null, '2. ENVOIE-LE AU CPE pour valider ton badge pHARe'),
                            e('li', null, '3. Tu peux le coller dans un mail ou un message')
                        )
                    )
                ),
                e('div', { className: 'btn-group' },
                    e('button', { className: 'btn btn-secondary', onClick: onMenu }, 'üè† RETOUR AU MENU'),
                    e('button', { className: 'btn btn-warning', onClick: onRestart }, 'üîÑ RECOMMENCER LE MODULE')
                )
            );
        }

        // --- Main App Component ---
        function App() {
            const [mode, setMode] = useState('menu'); // menu, register, game, report, load
            const [currentLevel, setCurrentLevel] = useState(1);
            const [cardIdx, setCardIdx] = useState(0);
            const [questionIdx, setQuestionIdx] = useState(0);
            const [scenarioIdx, setScenarioIdx] = useState(0);
            const [xp, setXp] = useState(0);
            const [quizScore, setQuizScore] = useState(0);
            const [dojoScore, setDojoScore] = useState(0);
            const [nom, setNom] = useState('');
            const [classe, setClasse] = useState('');
            const [inputCode, setInputCode] = useState('');
            const [loadError, setLoadError] = useState('');

            const resetProgress = () => {
                setCurrentLevel(1);
                setCardIdx(0);
                setQuestionIdx(0);
                setScenarioIdx(0);
                setXp(0);
                setQuizScore(0);
                setDojoScore(0);
            };

            const progress = {
                nom, classe, currentLevel, xp, quizScore, dojoScore,
                score: quizScore + dojoScore,
                finished: mode === 'report'
            };

            // --- MENU ---
            if (mode === 'menu') {
                return e('div', { className: 'app-container' },
                    e(Header, { showProgress: false }),
                    e('div', { className: 'card', style: { marginTop: '20px' } },
                        e('strong', null, 'üéØ MISSION : '),
                        MODULE_DATA.description
                    ),
                    e('div', { className: 'btn-group' },
                        e('button', { className: 'btn btn-block', onClick: () => setMode('register') }, 
                            '‚ñ∂Ô∏è COMMENCER LA MISSION'
                        ),
                        e('button', { className: 'btn btn-secondary btn-block', onClick: () => setMode('load') }, 
                            'üìÇ CHARGER UNE SAUVEGARDE'
                        )
                    ),
                    e('div', { style: { marginTop: '30px', textAlign: 'center', opacity: 0.6, fontSize: '0.85em' } },
                        `Module ${MODULE_DATA.id} v${MODULE_DATA.version} ‚Äî ${MODULE_DATA.auteur}`
                    )
                );
            }

            // --- REGISTER ---
            if (mode === 'register') {
                const startGame = () => {
                    if (!nom.trim()) {
                        alert('Merci d\'entrer ton pr√©nom ou pseudo !');
                        return;
                    }
                    setMode('game');
                };

                return e('div', { className: 'app-container' },
                    e(Header, { showProgress: false }),
                    e('div', { className: 'card' },
                        e('h3', { style: { marginBottom: '20px' } }, 'üë§ Identification de l\'Agent'),
                        e('div', { style: { marginBottom: '15px' } },
                            e('label', { style: { display: 'block', marginBottom: '5px', fontWeight: 'bold' } }, 'Pr√©nom ou Pseudo *'),
                            e('input', {
                                type: 'text',
                                value: nom,
                                onChange: (ev) => setNom(ev.target.value),
                                placeholder: 'Ex: Alex',
                                style: { width: '100%', padding: '12px', borderRadius: '8px', border: '2px solid #ddd', fontSize: '1rem' }
                            })
                        ),
                        e('div', { style: { marginBottom: '15px' } },
                            e('label', { style: { display: 'block', marginBottom: '5px', fontWeight: 'bold' } }, 'Classe (optionnel)'),
                            e('input', {
                                type: 'text',
                                value: classe,
                                onChange: (ev) => setClasse(ev.target.value),
                                placeholder: 'Ex: 4√®me B',
                                style: { width: '100%', padding: '12px', borderRadius: '8px', border: '2px solid #ddd', fontSize: '1rem' }
                            })
                        )
                    ),
                    e('div', { className: 'btn-group' },
                        e('button', { className: 'btn btn-success btn-block', onClick: startGame }, 'üöÄ D√âMARRER'),
                        e('button', { className: 'btn btn-secondary btn-block', onClick: () => setMode('menu') }, '‚Üê RETOUR')
                    )
                );
            }

            // --- LOAD ---
            if (mode === 'load') {
                const handleLoad = () => {
                    const result = decodeSaveCode(inputCode);
                    if (!result.valid) {
                        setLoadError(result.error);
                        return;
                    }
                    const d = result.data;
                    setNom(d.n || 'Anonyme');
                    setClasse(d.c || '');
                    setCurrentLevel(d.l || 1);
                    setXp(d.x || 0);
                    setQuizScore(d.q || 0);
                    setDojoScore(d.dj || 0);
                    setCardIdx(0);
                    setQuestionIdx(0);
                    setScenarioIdx(0);
                    
                    if (d.f) {
                        setMode('report');
                    } else {
                        setMode('game');
                    }
                    setLoadError('');
                };

                return e('div', { className: 'app-container' },
                    e(Header, { showProgress: false }),
                    e('div', { className: 'card load-section' },
                        e('h3', { style: { marginBottom: '20px' } }, 'üìÇ Charger une Progression'),
                        e('p', { style: { marginBottom: '15px', opacity: 0.8 } }, 
                            'Colle ici le code de sauvegarde que tu as gard√© :'
                        ),
                        e('textarea', {
                            value: inputCode,
                            onChange: (ev) => { setInputCode(ev.target.value); setLoadError(''); },
                            placeholder: 'Colle ton code ici...'
                        }),
                        loadError && e('div', { style: { color: '#e74c3c', marginTop: '10px', fontWeight: 'bold' } }, 
                            `‚ö†Ô∏è ${loadError}`
                        )
                    ),
                    e('div', { className: 'btn-group' },
                        e('button', { className: 'btn btn-success btn-block', onClick: handleLoad }, '‚úì CHARGER'),
                        e('button', { className: 'btn btn-secondary btn-block', onClick: () => setMode('menu') }, '‚Üê RETOUR')
                    )
                );
            }

            // --- GAME ---
            if (mode === 'game') {
                // NIVEAU 1 : FLASHCARDS
                if (currentLevel === 1) {
                    const cards = MODULE_DATA.niveau1.cartes;
                    
                    return e('div', { className: 'app-container' },
                        e(Header, { showProgress: true, xp }),
                        e(ProgressBar, { currentLevel, xp }),
                        e(LevelIndicator, { current: currentLevel }),
                        e('h2', { style: { textAlign: 'center' } }, 'üìö NIVEAU 1 : TH√âORIE'),
                        e('div', { className: 'card-counter' }, `Carte ${cardIdx + 1} / ${cards.length}`),
                        e(Flashcard, {
                            card: cards[cardIdx],
                            isLast: cardIdx === cards.length - 1,
                            onNext: () => setCardIdx(cardIdx + 1),
                            onComplete: () => {
                                setXp(xp + MODULE_DATA.niveau1.xp_reward);
                                setCurrentLevel(2);
                                setCardIdx(0);
                            }
                        })
                    );
                }

                // NIVEAU 2 : QUIZ
                if (currentLevel === 2) {
                    const questions = MODULE_DATA.niveau2.questions;
                    
                    const handleQuizAnswer = (correct) => {
                        if (correct) setQuizScore(quizScore + 25);
                        
                        if (questionIdx < questions.length - 1) {
                            setQuestionIdx(questionIdx + 1);
                        } else {
                            setXp(xp + MODULE_DATA.niveau2.xp_reward);
                            setCurrentLevel(3);
                            setQuestionIdx(0);
                        }
                    };

                    return e('div', { className: 'app-container' },
                        e(Header, { showProgress: true, xp }),
                        e(ProgressBar, { currentLevel, xp }),
                        e(LevelIndicator, { current: currentLevel }),
                        e('h2', { style: { textAlign: 'center' } }, 'üîç NIVEAU 2 : ANALYSE'),
                        e('div', { className: 'card-counter' }, `Question ${questionIdx + 1} / ${questions.length}`),
                        e(QuizQuestion, {
                            key: questionIdx, // Force re-render on new question
                            question: questions[questionIdx],
                            onAnswer: handleQuizAnswer
                        })
                    );
                }

                // NIVEAU 3 : DOJO
                if (currentLevel === 3) {
                    const scenarios = MODULE_DATA.niveau3.scenarios;
                    
                    const handleDojoAnswer = (impact) => {
                        setDojoScore(dojoScore + Math.max(0, impact));
                        
                        if (scenarioIdx < scenarios.length - 1) {
                            setScenarioIdx(scenarioIdx + 1);
                        } else {
                            setXp(xp + MODULE_DATA.niveau3.xp_reward);
                            setMode('report');
                        }
                    };

                    return e('div', { className: 'app-container' },
                        e(Header, { showProgress: true, xp }),
                        e(ProgressBar, { currentLevel, xp }),
                        e(LevelIndicator, { current: currentLevel }),
                        e('h2', { style: { textAlign: 'center' } }, '‚öîÔ∏è NIVEAU 3 : DOJO'),
                        e('div', { className: 'card-counter' }, `Sc√©nario ${scenarioIdx + 1} / ${scenarios.length}`),
                        e(DojoScenario, {
                            key: scenarioIdx,
                            scenario: scenarios[scenarioIdx],
                            onAnswer: handleDojoAnswer
                        })
                    );
                }
            }

            // --- REPORT ---
            if (mode === 'report') {
                return e('div', { className: 'app-container' },
                    e(Report, {
                        progress: { ...progress, xp: xp + (currentLevel > 3 ? 0 : MODULE_DATA.niveau3.xp_reward) },
                        onRestart: () => { resetProgress(); setMode('register'); },
                        onMenu: () => { resetProgress(); setMode('menu'); }
                    })
                );
            }

            return e('div', { className: 'app-container' }, 'Chargement...');
        }

        // --- RENDER ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>

</body>
</html>
